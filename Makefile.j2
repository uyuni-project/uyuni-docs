# Clean up build artifacts
.PHONY: clean-{{ langcode }}
clean-{{ langcode }}: clean-branding-{{ langcode }} ## Remove build artifacts from output directory (Antora and PDF)
	$(call clean-function,translations/{{ langcode }},{{ langcode }})

.PHONY: clean-branding-{{ langcode }}
clean-branding-{{ langcode }}:
	$(call clean-branding,{{ langcode }})

.PHONY: copy-branding-{{ langcode }}
copy-branding-{{ langcode }}: copy-branding
	$(call copy-branding,{{ langcode }})

.PHONY: configure-mlm-branding-dsc-{{ langcode }}
configure-mlm-branding-dsc-{{ langcode }}: configure-mlm-branding-dsc
	$(call configure-mlm-branding-dsc,{{ langcode }})

.PHONY: configure-mlm-branding-webui-{{ langcode }}
configure-mlm-branding-webui-{{ langcode }}: configure-mlm-branding-webui
	$(call configure-mlm-branding-webui,{{ langcode }})

.PHONY: validate-mlm-{{ langcode }}
validate-mlm-{{ langcode }}:
	$(call validate-product,translations/{{ langcode }},mlm-site.yml)

.PHONY: pdf-tar-mlm-{{ langcode }}
pdf-tar-mlm-{{ langcode }}:
	$(call pdf-tar-product,{{ langcode }},suse-multi-linux-manager-docs_{{ langcode }}-pdf,$(current_dir)/build/{{ langcode }}/pdf)

.PHONY: set-html-language-selector-mlm-{{ langcode }}
set-html-language-selector-mlm-{{ langcode }}: set-html-language-selector-mlm
	mkdir -p $(shell dirname translations/{{ langcode }}/$(SUPPLEMENTAL_FILES_MLM))
	cp -a translations/$(SUPPLEMENTAL_FILES_MLM) translations/{{ langcode }}/$(SUPPLEMENTAL_FILES_MLM)

.PHONY: prepare-antora-mlm-{{ langcode }}
prepare-antora-mlm-{{ langcode }}: copy-branding-{{ langcode }} set-html-language-selector-mlm-{{ langcode }}
	cd $(current_dir)
	mkdir -p $(current_dir)/translations/{{ langcode }} && \
	cp -a antora.yml translations/{{ langcode }}/antora.yml && \
	sed "s/\(url\:\ https\:\/\/documentation\.suse\.com\/mlm\/4\.3\/\)/\1{{ langcode }}\//;\
	s/\-\ url\:\ \./\-\ url\:\ \.\.\/\.\.\//;\
	s/start_path\:\ \./\start_path\:\ translations\/{{ langcode }}/;\
	s/dir:\ \.\/build\/en/dir:\ \.\.\/\.\.\/build\/{{ langcode }}/;" site.yml > translations/{{ langcode }}/mlm-site.yml && \
	cp -a $(current_dir)/modules $(current_dir)/translations/en/
	find modules/ -maxdepth 1 -name "*" -type d -exec mkdir -p $(current_dir)/translations/{{ langcode }}/{} \; && \
	mkdir -p $(current_dir)/translations/{{ langcode }}/modules/ROOT/pages/
	cp -a $(current_dir)/modules/ROOT/pages/common_gfdl1.2_i.adoc $(current_dir)/translations/{{ langcode }}/modules/ROOT/pages/	
	cd $(current_dir)

.PHONY: antora-mlm-{{ langcode }}
antora-mlm-{{ langcode }}: configure-mlm-branding-dsc-{{langcode}} prepare-antora-mlm-{{ langcode }} pdf-all-mlm-{{ langcode }} pdf-tar-mlm-{{ langcode }}
	$(call antora-mlm-function,translations/{{ langcode }},{{ langcode }})

	@echo "Running embedded PDF cleanup for {{ langcode }}..."

	@bash -c ' \
		# Cleanup Block Starts Here \
		\
		# Define directories \
		BUILD_DIR="build"; \
		PDF_DIR="$$BUILD_DIR/pdf"; \
		EN_PDF_DIR="$$BUILD_DIR/en/pdf"; \
		LOCALES="ko ja zh_CN"; \
		KEEP_FILES="suse_multi_linux_manager_administration_guide.pdf suse_multi_linux_manager_client-configuration_guide.pdf suse_multi_linux_manager_installation-and-upgrade_guide.pdf suse_multi_linux_manager_specialized-guides_guide.pdf"; \
		\
		# Debug Output \
		echo "BUILD_DIR is set to: $$BUILD_DIR"; \
		echo "PDF_DIR is set to: $$PDF_DIR"; \
		echo "EN_PDF_DIR is set to: $$EN_PDF_DIR"; \
		echo "Locales to process: $$LOCALES"; \
		echo "Files to keep: $$KEEP_FILES"; \
		\
		# Check if the build directory exists; create it if not \
		if [ ! -d "$$BUILD_DIR" ]; then \
		    echo "Warning: The build directory does not exist. Creating it now..."; \
		    mkdir -p "$$BUILD_DIR"; \
		fi; \
		\
		# Ensure target pdf directory exists \
		mkdir -p "$$PDF_DIR/en"; \
		\
		# Step 1: Copy all files from build/en/pdf/ to build/pdf/en/ \
		if [ -d "$$EN_PDF_DIR" ]; then \
		    echo "Copying English PDFs to $$PDF_DIR/en/"; \
		    cp -r "$$EN_PDF_DIR/"* "$$PDF_DIR/en/" 2>/dev/null || true; \
		else \
		    echo "Warning: English PDF directory not found. Skipping copy."; \
		fi; \
		\
		# Step 2 & 3: Process ko, ja, and zh_CN directories \
		for locale in $$LOCALES; do \
		    SRC_LOCALE_PDF="$$BUILD_DIR/$$locale/pdf"; \
		    DEST_LOCALE_PDF="$$PDF_DIR/$$locale"; \
		    \
		    if [ -d "$$SRC_LOCALE_PDF" ]; then \
		        echo "Processing PDFs for locale: $$locale"; \
		        mkdir -p "$$DEST_LOCALE_PDF"; \
		        \
		        for file in "$$SRC_LOCALE_PDF"/*; do \
		            if [ -f "$$file" ]; then \
		                filename=$$(basename "$$file"); \
		                if echo "$$KEEP_FILES" | grep -q "$$filename"; then \
		                    echo "Keeping $$file"; \
		                    mv "$$file" "$$DEST_LOCALE_PDF/"; \
		                else \
		                    echo "Removing $$file (not in keep list)"; \
		                    rm -f "$$file"; \
		                fi; \
		            fi; \
		        done; \
		        \
		        # Remove the now empty pdf directory \
		        rmdir "$$SRC_LOCALE_PDF" 2>/dev/null || true; \
		    else \
		        echo "Locale awaiting build...: $$locale"; \
		    fi; \
		done; \
		\
		# Step 4: Clean up remaining directories \
		echo "Cleaning up leftover PDF directories..."; \
		rm -rf "$$EN_PDF_DIR"; \
		for locale in $$LOCALES; do \
		    rm -rf "$$BUILD_DIR/$$locale/pdf"; \
		done; \
		\
		echo "PDF processing complete for {{ langcode }}." \
	'


.PHONY: obs-packages-mlm-{{ langcode }}
obs-packages-mlm-{{ langcode }}: configure-mlm-branding-webui-{{langcode}} pdf-all-mlm-{{ langcode }} antora-mlm-{{ langcode }} ## Generate mlm OBS tar files
	$(call obs-packages-product,{{ langcode }},{{ langcode }}/pdf,susemanager-docs_{{ langcode }},susemanager-docs_{{ langcode }}-pdf)

# UYUNI

.PHONY: validate-uyuni-{{ langcode }}
validate-uyuni-{{ langcode }}:
	$(call validate-product,translations/{{ langcode }},uyuni-site.yml)

.PHONY: pdf-tar-uyuni-{{ langcode }}
pdf-tar-uyuni-{{ langcode }}:
	$(call pdf-tar-product,{{ langcode }},uyuni-docs_{{ langcode }}-pdf,$(current_dir)/build/{{ langcode }}/pdf)

.PHONY: set-html-language-selector-uyuni-{{ langcode }}
set-html-language-selector-uyuni-{{ langcode }}: set-html-language-selector-uyuni
	mkdir -p $(shell dirname translations/{{ langcode }}/$(SUPPLEMENTAL_FILES_UYUNI))
	cp -a translations/$(SUPPLEMENTAL_FILES_UYUNI) translations/{{ langcode }}/$(SUPPLEMENTAL_FILES_UYUNI)

.PHONY: prepare-antora-uyuni-{{ langcode }}
prepare-antora-uyuni-{{ langcode }}: copy-branding-{{ langcode }} set-html-language-selector-uyuni-{{ langcode }}
	cd $(current_dir)
	mkdir -p $(current_dir)/translations/{{ langcode }} && \
	cp antora.yml translations/{{ langcode }}/antora.yml && \
	sed "s/\(url\:\ https\:\/\/www\.uyuni-project\.org\/uyuni-docs\/\)/\1{{ langcode }}\//;\
	s/\-\ url\:\ \./\-\ url\:\ \.\.\/\.\.\//;\
	s/start_path\:\ \./\start_path\:\ translations\/{{ langcode }}/;\
	s/dir:\ \.\/build\/en/dir:\ \.\.\/\.\.\/build\/{{ langcode }}/;" site.yml > translations/{{ langcode }}/uyuni-site.yml && \
	cp -a $(current_dir)/modules $(current_dir)/translations/en/
	find modules/ -maxdepth 1 -name "*" -type d -exec mkdir -p $(current_dir)/translations/{{ langcode }}/{} \; && \
	mkdir -p $(current_dir)/translations/{{ langcode }}/modules/ROOT/pages/	
	cp -a $(current_dir)/modules/ROOT/pages/common_gfdl1.2_i.adoc $(current_dir)/translations/{{ langcode }}/modules/ROOT/pages/	
	cd $(current_dir)

.PHONY: antora-uyuni-{{ langcode }}
antora-uyuni-{{ langcode }}: prepare-antora-uyuni-{{ langcode }} pdf-all-uyuni-{{ langcode }} pdf-tar-uyuni-{{ langcode }}
	$(call antora-uyuni-function,translations/{{ langcode }},{{ langcode }})

.PHONY: obs-packages-uyuni-{{ langcode }}
obs-packages-uyuni-{{ langcode }}: pdf-all-uyuni-{{ langcode }} antora-uyuni-{{ langcode }} ## Generate UYUNI OBS tar files
	$(call obs-packages-product,{{ langcode }},{{ langcode }}/pdf,uyuni-docs_{{ langcode }},uyuni-docs_{{ langcode }}-pdf)
