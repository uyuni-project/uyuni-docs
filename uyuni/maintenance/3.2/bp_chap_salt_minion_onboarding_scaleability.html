<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salt Minion Scalability :: Uyuni Documentation</title>
    <meta name="generator" content="Antora 1.1.0">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <link rel="stylesheet" href="../../../_/css/site-extra.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css">
    <!-- fetched from https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css -->
    <link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="https://infallible-goldberg-3dc8f3.netlify.com/uyuni/master/">Uyuni Project</a>
        <span class="separator">//</span>
        <a href="../../..">Docs</a>
      </div>
      <div class="navbar-item">
        <input id="search-input" type="text" placeholder="Search docs">
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Projects</div>
          <div class="navbar-dropdown">
            <div class="navbar-item"><strong>Resources</strong></div>
            <a class="navbar-item" href="https://gitlab.com/jcayouette/uyuni-prototype">Repository</a>
            <a class="navbar-item" href="https://gitlab.com/jcayouette/uyuni-prototype/issues">Issue Tracker</a>
<!--
            <hr class="navbar-divider">
            <div class="navbar-item"><strong>Custom UI (coming soon!)</strong></div>
            <a class="navbar-item" href="https://gitlab.com/antora/antora-ui-default">Repository</a>
            <a class="navbar-item" href="https://gitlab.com/antora/antora-ui-default/issues">Issue Tracker</a>
            <hr class="navbar-divider">
          -->
            <a class="navbar-item" href="https://gitlab.com/jcayouette/uyuni-prototype/blob/master/contributing.adoc">Contributing</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Community</div>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="https://gitter.im/uyuniproject/users">Uyuni Chat (Users)</a>
            <a class="navbar-item" href="https://gitter.im/uyuniproject/develop">Uyuni Chat (Dev)</a>
          </div>
        </div>
        <a class="navbar-item" href="https://twitter.com/uyuniproject">
          <span class="icon">
            <svg aria-hidden="true" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
              <path fill="#57aaee" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path>
            </svg>
          </span>
        </a>
      </div>
    </div>
  </nav>
</header>
<div class="main-wrapper">
<div class="navigation-container" data-component="uyuni" data-version="maintenance/3.2">
  <aside class="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Uyuni</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="book_mgr_getting_started.html">Getting Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="quickstart3_chap_install_overview.html">Overview and Requirements</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#quickstart.sect.introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#quickstart.sect.prereq">Prerequisites for Installation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#quickstart.sect.prereq.scc">SUSE SCC Credentials</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#quickstart.sect.prereq.installmedia">Get Uyuni</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#quickstart.sect.prereq.hardware">Hardware Requirements</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#quickstart.sect.prereq.network">Network Requirements</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#quickstart.sect.prereq.clientos">Supported Client Systems</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="quickstart3_chap_suma_installation_jeos.html">Installation via JeOS</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#quickstart.sect.kvm.settings">Configuring KVM</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#jeos.kvm.settings">JeOS KVM Settings</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#jeos.susemgr.prep">Preparing JeOS for Uyuni</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="quickstart3_chap_suma_installation_sles.html">Installation via SLES</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="quickstart3_chap_suma_setup_with_yast.html">Setup and Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="quickstart3_chap_suma_keys_and_first_client.html">Connecting Clients</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="quickstart3_chap_suma_salt_gs.html">Introduction to Salt</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="book_mgr_best_practices.html">Best Practices</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="book_suma_reference_manual.html">WebUI Reference</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="book_suma_advanced_topics.html">Advanced Topics</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">Uyuni</span>
    <span class="version">maintenance/3.2</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Uyuni</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../Master/index.html">Master</a>
        </li>
        <li class="version">
          <a href="../../include-test/index.html">include-test</a>
        </li>
        <li class="version">
          <a href="../../ia-rework/index.html">ia-rework</a>
        </li>
        <li class="version is-current">
          <a href="index.html">maintenance/3.2</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
  <a href="../../Master/index.html" class="home-link"></a>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="index.html">Uyuni</a></li>
    <li class="crumb"><a href="bp_chap_salt_minion_onboarding_scaleability.html">Salt Minion Scalability</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="versions-menu-toggle" title="Show other versions of page">maintenance/3.2</button>
  <div class="versions-menu">
    <a class="version" href="../../Master/bp_chap_salt_minion_onboarding_scaleability.html">Master</a>
    <a class="version" href="../../include-test/bp_chap_salt_minion_onboarding_scaleability.html">include-test</a>
    <a class="version" href="../../ia-rework/bp_chap_salt_minion_onboarding_scaleability.html">ia-rework</a>
    <a class="version is-current" href="bp_chap_salt_minion_onboarding_scaleability.html">maintenance/3.2</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/uyuni-project/uyuni-docs/edit/maintenance/3.2/docs/modules/ROOT/pages/bp_chap_salt_minion_onboarding_scaleability.adoc">Edit this Page</a></div>
</div>
<article class="doc">
<h1>Salt Minion Scalability</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_salt_minion_onboarding_rate">Salt Minion Onboarding Rate</a></li>
<li><a href="#bp.chap.salt.minion.scaleability.unaccepted">Minions Running with Unaccepted Salt Keys</a></li>
<li><a href="#bp.chap.salt.minion.scaleability.timeouts">Salt Timeouts</a>
<ul class="sectlevel2">
<li><a href="#_background_information">Background Information</a></li>
<li><a href="#bp.chap.salt.minion.scaleability.timeouts.presence">A Presence Ping Mechanism for Unreachable Salt Minions</a></li>
<li><a href="#_overriding_salt_presence_timeout_values">Overriding Salt Presence Timeout Values</a></li>
<li><a href="#_salt_ssh_minions_ssh_push">Salt SSH Minions (SSH Push)</a></li>
</ul>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="_salt_minion_onboarding_rate"><a class="anchor" href="#_salt_minion_onboarding_rate"></a><a class="link" href="#_salt_minion_onboarding_rate">Salt Minion Onboarding Rate</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The rate at which SUSE Manager can on-board minions (accept Salt keys) is limited and depends on hardware resources.
On-boarding minions at a faster rate than SUSE Manager is configured for will build up a backlog of unprocessed keys slowing the process and potentially exhausting resources.
It is recommended to limit the acceptance key rate pro-grammatically.
A safe starting point would be to on-board a minion every 15 seconds, which can be implemented via the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>for k in $(salt-key -l un|grep -v Unaccepted); do salt-key -y -a $k; sleep 15; done</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="bp.chap.salt.minion.scaleability.unaccepted"><a class="anchor" href="#bp.chap.salt.minion.scaleability.unaccepted"></a><a class="link" href="#bp.chap.salt.minion.scaleability.unaccepted">Minions Running with Unaccepted Salt Keys</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Minions which have not been on-boarded, (minions running with unaccepted Salt keys) consume resources, in particular inbound network bandwidth for ~2.5 Kb/s per minion.
1000 idle minions will consume around ~2.5 Mb/s, and this number will drop to almost 0 once on-boarding has been completed.
Limit non-onboarded systems for optimal performance.</p>
</div>
<div class="paragraph">
<p>Salt&#8217;s official documentation suggests the maximum number of opened files should be set to at least 2 × the minion count.
Current default is 16384, which is sufficient for ~8000 minions.
For larger installations, this number may be increased by editing the following line in <code class="path">/usr/lib/systemd/system/salt-master.service</code>
:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>LimitNOFILE=16384</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="bp.chap.salt.minion.scaleability.timeouts"><a class="anchor" href="#bp.chap.salt.minion.scaleability.timeouts"></a><a class="link" href="#bp.chap.salt.minion.scaleability.timeouts">Salt Timeouts</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_background_information"><a class="anchor" href="#_background_information"></a><a class="link" href="#_background_information">Background Information</a></h3>
<div class="paragraph">
<p>Salt features two timeout parameters called <code>timeout</code> and <code>gather_job_timeout</code> that are relevant during the execution of Salt commands and jobs&#8212;&#8203;it does not matter whether they are triggered using the command line interface or API.
These two parameters are explained in the following article.</p>
</div>
<div class="paragraph">
<p>This is a normal workflow when all minions are well reachable:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A salt command or job is executed:</p>
<div class="listingblock">
<div class="content">
<pre>salt '*' test.ping</pre>
</div>
</div>
</li>
<li>
<p>Salt master publishes the job with the targeted minions into the Salt PUB channel.</p>
</li>
<li>
<p>Minions take that job and start working on it.</p>
</li>
<li>
<p>Salt master is looking at the Salt RET channel to gather responses from the minions.</p>
</li>
<li>
<p>If Salt master gets all responses from targeted minions, then everything is completed and Salt master will return a response containing all the minion responses.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If some of the minions are down during this process, the workflow continues as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If <code>timeout</code> is reached before getting all expected responses from the minions, then Salt master would trigger an aditional job (a Salt <code class="command">find_job</code> job) targeting only pending minions to check whether the job is already running on the minion.</p>
</li>
<li>
<p>Now <code>gather_job_timeout</code> is evaluated. A new counter is now triggered.</p>
</li>
<li>
<p>If this new <code class="command">find_job</code> job responses that the original job is actually running on the minion, then Salt master will wait for that minion&#8217;s response.</p>
</li>
<li>
<p>In case of reaching <code>gather_job_timeout</code> without having any response from the minion (neither for the initial <code class="command">test.ping</code> nor for the <code class="command">find_job</code> job), Salt master will return with only the gathered responses from the responding minions.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>By default,  globally sets <code>timeout</code> and <code>gather_job_timeout</code> to 120 seconds.
So, in the worst case, a Salt call targeting unreachable minions will end up <em>with 240 seconds of waiting</em> until getting a response.</p>
</div>
</div>
<div class="sect2">
<h3 id="bp.chap.salt.minion.scaleability.timeouts.presence"><a class="anchor" href="#bp.chap.salt.minion.scaleability.timeouts.presence"></a><a class="link" href="#bp.chap.salt.minion.scaleability.timeouts.presence">A Presence Ping Mechanism for Unreachable Salt Minions</a></h3>
<div class="paragraph">
<p>In order to prevent waiting until timeouts are reached when some minions are down, SUSE
introduced a so-called "presence mechanism" for Salt minions.</p>
</div>
<div class="paragraph">
<p>This presence mechanism checks for unreachable Salt minions when  is performing synchronous calls to these minions, and it excludes unreachable minions from that call.
Synchronous calls are going to be displaced in favor of asynchronous calls but currently still being used during some workflows.</p>
</div>
<div class="paragraph">
<p>The presence mechanism triggers a Salt <code class="command">test.ping</code> with a custom and fixed short Salt timeout values.
Default Salt values for the presence ping are: <code>timeout
     = 4</code> and <code>gather_job_timeout = 1</code>.
This way, we can quickly detect which targeted minions are unreachable, and then exclude them from the synchronous call.</p>
</div>
</div>
<div class="sect2">
<h3 id="_overriding_salt_presence_timeout_values"><a class="anchor" href="#_overriding_salt_presence_timeout_values"></a><a class="link" href="#_overriding_salt_presence_timeout_values">Overriding Salt Presence Timeout Values</a></h3>
<div class="paragraph">
<p> administrators can increase or decrease default presence ping timeout values by removing the comment markers (<code>\#</code>) and setting the desired values for <code>salt_presence_ping_timeout</code> and <code>salt_presence_ping_gather_job_timeout</code> options in <code class="path">/etc/rhn/rhn.conf</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># SUSE Manager presence timeouts for Salt minions
# salt_presence_ping_timeout = 4
# salt_presence_ping_gather_job_timeout = 1</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_salt_ssh_minions_ssh_push"><a class="anchor" href="#_salt_ssh_minions_ssh_push"></a><a class="link" href="#_salt_ssh_minions_ssh_push">Salt SSH Minions (SSH Push)</a></h3>
<div class="paragraph">
<p>Salt SSH minions are slightly different that regular minions (zeromq). Salt SSH minions do not use Salt PUB/RET channels but a wrapper Salt command inside of an SSH call.
Salt <code>timeout</code> and <code>gather_job_timeout</code> are not playing a role here.</p>
</div>
<div class="paragraph">
<p> defines a timeout for SSH connections in <code class="path">/etc/rhn/rhn.conf</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># salt_ssh_connect_timeout = 180</pre>
</div>
</div>
<div class="paragraph">
<p>The presence ping mechanism is also working with SSH minions.
In this case,  will use <code>salt_presence_ping_timeout</code> to override the default timeout value for SSH connections.</p>
</div>
</div>
</div>
</div>
</article>
  </main>
</div>
<footer class="footer">
  <p>Copyright (C) 2017-2018 <a href="https://gitlab.com/jcayouette/uyuni-prototype">Uyuni Project</a></p>
  <p>Testing Disclaimer...</p>
</footer>
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<!-- fetched from https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js -->
<script>
function focusSearchInput () { document.querySelector('#search-input').focus() }
var search = docsearch({
  appId: '3F9C504TVA',
  apiKey: '72c8bc420354328a066360837f11319e',
  indexName: 'uyuni-project',
  inputSelector: '#search-input',
  autocompleteOptions: { hint: false, keyboardShortcuts: ['s'] },
  algoliaOptions: { hitsPerPage: 10 }
}).autocomplete
search.on('autocomplete:closed', function () { search.autocomplete.setVal() })
focusSearchInput()
window.addEventListener('load', focusSearchInput)
</script>
<script src="../../../_/js/site.js"></script>
<script src="../../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
  </body>
</html>
