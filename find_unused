#!/bin/bash

CURRENT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
EXIT_CODE=0

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Draws a usage bar like [██████░░░░░░] with colors
draw_bar() {
  local percent=$1
  local bars=$((percent / 10))
  local empty=$((10 - bars))
  local bar=""
  for ((i = 0; i < bars; i++)); do bar+="█"; done
  for ((i = 0; i < empty; i++)); do bar+="░"; done

  if (( percent == 100 )); then
    echo -e "${GREEN}[$bar] $percent% used${NC}"
  elif (( percent >= 70 )); then
    echo -e "${YELLOW}[$bar] $percent% used${NC}"
  else
    echo -e "${RED}[$bar] $percent% used${NC}"
  fi
}

find_unused() {
  GUIDE_NAME=$1
  echo "Scanning for unused files...: ${GUIDE_NAME^^}"

  GUIDE_DIR="$CURRENT_DIR/modules/$GUIDE_NAME/pages"
  NAV_FILE="$CURRENT_DIR/modules/$GUIDE_NAME/nav-$GUIDE_NAME-guide.adoc"

  if [ ! -d "$GUIDE_DIR" ]; then
    echo "  => No directory found: $GUIDE_DIR"
    return
  fi

  if [ ! -f "$NAV_FILE" ]; then
    echo "  => No nav file found: $NAV_FILE"
    return
  fi

  UNUSED_IN_GUIDE=0
  TOTAL_FILES=0

  for I in "$GUIDE_DIR"/*.adoc; do
    FILE_NAME=$(basename "$I")

    # Skip README.adoc
    if [ "$FILE_NAME" == "README.adoc" ]; then
      continue
    fi

    TOTAL_FILES=$((TOTAL_FILES + 1))

    grep -q "$FILE_NAME" "$NAV_FILE" "$GUIDE_DIR"/*.adoc
    grepsult=$?

    if [ "$grepsult" -eq 0 ]; then
      echo -e "  $FILE_NAME... ${GREEN}yes${NC}"
    else
      echo -e "  $FILE_NAME... ${RED}NO${NC}"
      UNUSED_IN_GUIDE=$((UNUSED_IN_GUIDE + 1))
      EXIT_CODE=$((EXIT_CODE + 1))
    fi
  done

  USED_FILES=$((TOTAL_FILES - UNUSED_IN_GUIDE))
  if [ "$TOTAL_FILES" -gt 0 ]; then
    PERCENT=$(( 100 * USED_FILES / TOTAL_FILES ))
  else
    PERCENT=100
  fi

  echo "  => Unused files in $GUIDE_NAME guide: $UNUSED_IN_GUIDE of $TOTAL_FILES"
  draw_bar "$PERCENT"
  echo
}

# Loop over all guides
for dir in "$CURRENT_DIR"/modules/*; do
  if [ -d "$dir/pages" ]; then
    GUIDE_NAME=$(basename "$dir")
    find_unused "$GUIDE_NAME"
  fi
done

echo "EXIT_CODE = $EXIT_CODE"
exit $EXIT_CODE
