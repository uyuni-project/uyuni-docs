<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
<title>Salt SSH
     | SUSE Manager 4.3 Documentation</title>    <link rel="canonical" href="https://documentation.suse.com/suma/4.3/en/suse-manager/specialized-guides/salt/salt-ssh.html">
    <link rel="prev" href="salt-formulas-custom.html">
    <link rel="next" href="salt-rate-limiting.html">
    <meta name="generator" content="Antora 3.1.2">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="stylesheet" href="../../../_/css/search.css">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="../../../_/css/font-styles.css">
<link rel="stylesheet" href="../../../_/fonts/css/all.css">
<link rel="stylesheet" href="../../../_/css/site-extra.css">
<!-- <link rel="preconnect" href="https://fonts.gstatic.com"> -->
<link href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css" rel="stylesheet">
<!-- <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto&display=swap" rel="stylesheet"> -->
<link rel="stylesheet" href="../../../_/css/vendor/light.css">
<script src="/docserv/res/lightheaded/analytics.js"
        type="text/javascript"></script>
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
   <div class="navbar-brand">
            <div class="navbar-item">
                <a class=" navbar-logo" href="https://documentation.suse.com/suma/"><img
                        class="logo" src="../../../_/img/logo.svg"/></a>
            </div>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
     <div id="topbar-nav" class="navbar-menu">
          <div class="navbar-end">
              <div class="navbar-item has-dropdown is-hoverable">
                  <div class="navbar-link"><img src="../../../_/img/resources.png" class="langIcon Resurces" alt="Resources" title="Resources"></div>
                  <div class="navbar-dropdown">
                      <!--  <div class="navbar-item"><strong>Resources</strong></div> -->
                      <a class="navbar-item" href="https://github.com/uyuni-project/uyuni-docs"><i
                              class="fab fa-github"></i>&nbsp;uyuni-docs</a>
                      <a class="navbar-item" href="https://github.com/uyuni-project/uyuni-docs/issues"><i
                              class="fab fa-github"></i>&nbsp;Report Issue</a>
                      <a class="navbar-item"
                         href="https://github.com/uyuni-project/uyuni-docs/wiki"><i
                              class="fas fa-user-edit"></i>&nbsp;Contribute</a>
                  </div>
              </div>
                           <div class="navbar-item has-dropdown is-hoverable">
                 <div class="navbar-link"><img src="../../../_/img/language.png" class="langIcon Language" alt="Language" title="Language"></div>
                 <div class="navbar-dropdown">
                     <!--  </div><div>Icons made by <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div> -->
                     <a role="button" class="navbar-item" id="en" onclick="selectLanguage(this.id)"><img src="../../../_/img/engFlag.svg" class="langIcon english">&nbsp;English</a>
                     <!-- LANGUAGESELECTOR -->
                     <a role="button" class="navbar-item" id="ko" onclick="selectLanguage(this.id)"><img src="../../../_/img/koFlag.svg" class="langIcon korea">&nbsp;한국어</a>
                     <a role="button" class="navbar-item" id="ja" onclick="selectLanguage(this.id)"><img src="../../../_/img/jaFlag.svg" class="langIcon japan">&nbsp;日本語</a>
                     <a role="button" class="navbar-item" id="zh_CN" onclick="selectLanguage(this.id)"><img src="../../../_/img/china.svg" class="langIcon china">&nbsp;中文</a>
                 </div>
             </div>
                
          </div>
      </div>
      <a id="twitter-link" class="navbar-item" href="https://twitter.com/susemanager">
          <span class="icon">
            <svg aria-hidden="true" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg"
                 viewBox="0 0 512 512">
              <path fill="#57aaee"
                    d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path>
            </svg>
          </span>
      </a>
   <!--   <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">

        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
      </div> -->
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="suse-manager" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">SUSE Manager 4.3 Documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../common_gfdl1.2_i.html">License</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../specialized-guides-overview.html">Specialized Guides</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../public-cloud-guide/overview.html">Public Cloud Guide</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Generic Public Cloud</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../public-cloud-guide/setup.html">Initial Setup</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../public-cloud-guide/clients.html">Client Configuration</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">PAYG Guide</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../public-cloud-guide/payg/payg-overview.html">Pay-as-you-go Overview</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../public-cloud-guide/payg/payg-benefits.html">Benefits of PAYG</a>
  </li>
  <li class="nav-item" data-depth="4">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">PAYG on AWS</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../public-cloud-guide/payg/payg-faq.html">PAYG FAQ on AWS</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../public-cloud-guide/payg/payg-country-listing.html">Supported Country List</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../public-cloud-guide/payg/payg-aws-requirements.html">SUSE Manager AWS requirements</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../public-cloud-guide/payg/payg-find-the-aws-image.html">Find the Image</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../public-cloud-guide/payg/payg-configure-the-image.html">Configure the Image on EC2</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../public-cloud-guide/payg/payg-start-the-image.html">Start the Instance</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../public-cloud-guide/payg/payg-initial-setup.html">Initial Setup</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../public-cloud-guide/payg/payg-start-the-server.html">Start the Server</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../public-cloud-guide/payg/payg-webui-configuration.html">WebUI Configuration</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="salt-overview.html">Salt Guide</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="salt-terminology.html">Terminology</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="salt-command.html">Salt Command</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="salt-useful-commands.html">Common Salt Commands</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="salt-states-and-pillars.html">Salt States and Pillars</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="salt-gpg-encrypted-pillars.html">GPG Encrypted Pillars</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="salt-custom-states.html">Custom Salt States</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="salt-file-locations.html">File Locations</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="salt-gitfs.html">GitFS Fileserver Backend</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="salt-yomi.html">Install Using Yomi</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="salt-config-modules.html">Configuration Modules</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="salt-formulas-intro.html">Salt Formulas</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="salt-formulas-by-product.html">Formulas provided by SUSE Manager</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="salt-formula-bind.html">Bind Formula</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="salt-formula-branchnetwork.html">Branch Network Formula</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="salt-formula-dhcpd.html">DHCPd Formula</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="salt-formula-imagesync.html">Image Sync Formula</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="salt-formula-monitoring.html">Monitoring Formulas</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="salt-formula-pxe.html">PXE Formula</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="salt-formula-saltboot.html">Saltboot Formula</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="salt-formula-tftpd.html">TFTPd Formula</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="salt-formula-vsftpd.html">VsFTPd Formula</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="salt-formula-yomi.html">Yomi Formula</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="salt-formulas-custom.html">Custom Salt Formulas</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="salt-ssh.html">Salt SSH</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="salt-rate-limiting.html">Rate Limiting</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="salt-scaling-minions.html">Scaling Minions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../large-deployments/overview.html">Large Deployments Guide</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../large-deployments/hardware-reqs.html">Hardware Requirements</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../large-deployments/single-server.html">Single Server</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../large-deployments/operation-reqs.html">Operation Requirements</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../large-deployments/multi-server.html">Multiple Servers with Hub</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../large-deployments/hub-reqs.html">Hub Operation Requirements</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../large-deployments/hub-install.html">Hub Installation</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../large-deployments/hub-api.html">Hub API</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../large-deployments/hub-namespaces.html">Hub Namespaces</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../large-deployments/hub-auth.html">Hub Authentication</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../large-deployments/hub-reporting.html">Hub Reporting</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../large-deployments/retail-large-scale.html">Large Retail Environments</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../large-deployments/tuning.html">Tuning Large Installations</a>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">xref:large-deployments/monitoring.adoc[Monitoring Large Scale Deployments</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../qs-sap/overview.html">Quick Start: SAP</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../qs-sap/prepare-server.html">Prepare Server</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../qs-sap/prepare-clients.html">Prepare Clients</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../qs-sap/configure.html">Configuration</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">SUSE Manager 4.3 Documentation</span>
    <span class="version">default</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../../index.html">SUSE Manager 4.3 Documentation</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">default</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">SUSE Manager 4.3 Documentation</a></li>
    <li><a href="../specialized-guides-overview.html">Specialized Guides</a></li>
    <li><a href="salt-overview.html">Salt Guide</a></li>
    <li><a href="salt-ssh.html">Salt SSH</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="On this page" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Salt SSH</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_ssh_connection_methods">1. SSH Connection Methods</a></li>
<li><a href="#_salt_ssh_integration">2. Salt SSH Integration</a></li>
<li><a href="#_authentication">3. Authentication</a></li>
<li><a href="#salt.ssh.user">4. User Account</a></li>
<li><a href="#_http_redirection">5. HTTP Redirection</a></li>
<li><a href="#_call_sequence">6. Call Sequence</a></li>
<li><a href="#_bootstrap_sequence">7. Bootstrap Sequence</a></li>
<li><a href="#_proxy_support">8. Proxy Support</a></li>
<li><a href="#_users_and_ssh_key_management">9. Users and SSH Key Management</a></li>
<li><a href="#_repository_access_with_a_proxy">10. Repository Access with a Proxy</a></li>
<li><a href="#_proxy_setup">11. Proxy Setup</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Salt SSH allows Salt commands and states to be issued directly over SSH.
SSH connections are created on demand, when the server executes an action on a client.</p>
</div>
<div class="paragraph">
<p>For more information about Salt SSH, see <a href="https://docs.saltstack.com/en/latest/topics/ssh/" class="bare">https://docs.saltstack.com/en/latest/topics/ssh/</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ssh_connection_methods"><a class="anchor" href="#_ssh_connection_methods"></a><a class="link" href="#_ssh_connection_methods">1. SSH Connection Methods</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In SUSE Manager there are two SSH connection methods, <code>ssh-push</code> and <code>ssh-push-tunnel</code>.
In both methods the server initiates an SSH connection to the client to execute a Salt call.</p>
</div>
<div class="paragraph">
<p>In the <code>ssh-push</code> method, the package manager works as normal, and the HTTP or HTTPS connection is directly created.</p>
</div>
<div class="paragraph">
<p>In the <code>ssh-push-tunnel</code> method, the server creates an HTTP or HTTPS connection through an SSH tunnel.
The HTTP connection initiated by the package manager is redirected through the tunnel using <code>/etc/hosts</code> aliasing.
Use this method for in-place firewall environments that block HTTP or HTTPS connections between server and client.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_salt_ssh_integration"><a class="anchor" href="#_salt_ssh_integration"></a><a class="link" href="#_salt_ssh_integration">2. Salt SSH Integration</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>As with all Salt calls, SUSE Manager invokes <code>salt-ssh</code> via the <code>salt-api</code>.</p>
</div>
<div class="paragraph">
<p>Salt SSH relies on a roster to obtain details such as hostname, ports, and the SSH parameters of a client.
SUSE Manager keeps these details in the database and makes them available to Salt SSH by using the <code class="literal">uyuni</code> roster module, or by generating a temporary roster file on bootstrapping new clients with the Web UI.
The location of the temporary roster file is supplied to Salt SSH using the <code class="option">roster-file</code> option.
For the registered clients <code class="option">roster</code> set to <code>uyuni</code> is used instead to get the roster from the database with <code>uyuni</code> salt roster module.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is not recommended to run <code class="command">salt-ssh</code> as <code class="literal">root</code> user. This can cause permission issues the next time SUSE Manager tries to use Salt SSH.
Use <code class="command">mgr-salt-ssh</code>, which changes the effective user to <code class="literal">salt</code> and avoids file permission issues.
If you want to use <code class="command">mgr-salt-ssh</code> with a user other than <code class="literal">root</code>, the user should have the permission to change effective user to <code class="literal">salt</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code class="command">mgr-salt-ssh</code> uses <code class="option">roster</code> set to <code class="literal">uyuni</code> by default, if neither <code class="option">roster</code> nor <code class="option">roster-file</code> specified in the command line.
It helps to call Salt commands to the registered Salt SSH clients with no roster file generation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authentication"><a class="anchor" href="#_authentication"></a><a class="link" href="#_authentication">3. Authentication</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Salt SSH supports both password and key authentication.
SUSE Manager uses both methods:</p>
</div>
<div class="paragraph">
<p>Password authentication is used only when bootstrapping.
During the bootstrap step the key of the server is not authorized on the client and therefore a password must be used for a connection to be made.
The password is used transiently in a temporary roster file used for bootstrapping and the roster file is removed on finishing processing the event.
This password is not stored.</p>
</div>
<div class="paragraph">
<p>All other common Salt calls use key authentication.
During the bootstrap step the SSH key of the server is authorized on the client and added to the client <code class="path">/.ssh/authorized_keys</code> file.
Subsequent calls no longer require a password.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="salt.ssh.user"><a class="anchor" href="#salt.ssh.user"></a><a class="link" href="#salt.ssh.user">4. User Account</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The user for Salt SSH calls made by SUSE Manager is taken from the <code>ssh_push_sudo_user</code> setting.
By default, the user is root.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If bootstrapping with default settings fail, check whether the client allows root login with ssh.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the value of <code>ssh_push_sudo_user</code> is not root, then the <code>--sudo</code> options of <code>salt-ssh</code> are used.
For this user you must configure the <code>NOPASSWD</code> option in the <code class="path">sudoers</code> file.
At least, set the python binary with the version number; for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;USER&gt; ALL=(ALL) NOPASSWD:/usr/bin/python3.6</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_http_redirection"><a class="anchor" href="#_http_redirection"></a><a class="link" href="#_http_redirection">5. HTTP Redirection</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>ssh-push-tunnel</code> method requires traffic to be redirected through an SSH tunnel.
This allows traffic to bypass firewalls blocking a direct connection between the client and the server.</p>
</div>
<div class="paragraph">
<p>This is achieved by using port 1233 in the repository URL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>https://suma-server:1233/repourl...</pre>
</div>
</div>
<div class="paragraph">
<p>You can alias the suma-server hostname to <code class="literal">localhost</code> in <code class="path">/etc/hosts</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>127.0.0.1       localhost    suma-server</pre>
</div>
</div>
<div class="paragraph">
<p>The server creates a reverse SSH tunnel that connects <code>localhost:1233</code> on the client to <code>suma-server:443</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ssh ... -R 1233:suma-server:443</pre>
</div>
</div>
<div class="paragraph">
<p>This means that the package manager will actually connect to <code>localhost:1233</code>, which is then forwarded to <code>suma-server:443</code> by the SSH tunnel.</p>
</div>
<div class="paragraph">
<p>The package manager can contact the server only if the tunnel is open, which occurs only when the server executes an action on the client.</p>
</div>
<div class="paragraph">
<p>Manual package manager operations that require server connectivity are not possible in this case.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_call_sequence"><a class="anchor" href="#_call_sequence"></a><a class="link" href="#_call_sequence">6. Call Sequence</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Salt SSH calls run in this sequence:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Set <code>roster</code> parameter to <code>uyuni</code> for registered clients or prepare the Salt roster on bootstrapping for the call</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Create remote port forwarding option if the contact method is <code>ssh-push-tunnel</code></p>
</li>
<li>
<p>Compute the <code>ProxyCommand</code> if the client is connected through a proxy</p>
</li>
<li>
<p>Create Roster content</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create a temporary roster file (only in case of bootstrapping new client)</p>
</li>
<li>
<p>Execute a synchronous <code>salt-ssh</code> call using the API</p>
</li>
<li>
<p>Remove the temporary roster file (only in case of bootstrapping new client)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The roster content contains:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hostname</code></p>
</li>
<li>
<p><code>user</code></p>
</li>
<li>
<p><code>port</code></p>
</li>
<li>
<p><code>remote_port_forwards</code>: The remote port forwarding SSH option</p>
</li>
<li>
<p><code>ssh_options</code>: Other ssh options:</p>
<div class="ulist">
<ul>
<li>
<p><code>ProxyCommand</code>: If the client connects through a proxy</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>timeout</code>: defaults to 180 seconds</p>
</li>
<li>
<p><code>minion_opts</code>:</p>
<div class="ulist">
<ul>
<li>
<p><code>master</code>: Set to the minion ID if the contact method is <code>ssh-push-tunnel</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>ssh_pre_flight</code>: The path to the shell script executed on the client before running any Salt command</p>
</li>
<li>
<p><code>ssh_pre_flight_args</code>: The list of arguments to call the pre flight script on the client</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bootstrap_sequence"><a class="anchor" href="#_bootstrap_sequence"></a><a class="link" href="#_bootstrap_sequence">7. Bootstrap Sequence</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes the sequence of events when clients are registered to a Salt master.
While bootstrapping is a type of Salt SSH call, the sequence differs slightly from regular SSH calls.</p>
</div>
<div class="paragraph">
<p>Bootstrapping uses Salt SSH for communication between the master and the client.
This happens for both regular and SSH clients.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>For a regular Salt client, generate and pre-authorize the Salt key of the client.</p>
</li>
<li>
<p>For an SSH client, if a proxy was selected, retrieve the SSH public key of the proxy using the <code>mgrutil.chain_ssh_cmd</code> runner.
The runner copies the public key of the proxy to the server using SSH.
If needed, it can chain multiple SSH commands to reach the proxy across multiple hops.</p>
</li>
<li>
<p>Generate pillar data for bootstrap.
The pillar data is compiled and stored on the Salt master, and retrieved by the client.</p>
</li>
<li>
<p>Generate the roster for bootstrapping into a temporary file on the client.
You can use the roster by passing it to the Salt API, with this command:</p>
<div class="listingblock">
<div class="content">
<pre>mgr-salt-ssh --roster-file=&lt;temporary_bootstrap_roster&gt; minion state.apply certs,&lt;bootstrap_state&gt;`</pre>
</div>
</div>
<div class="paragraph">
<p>For <code>bootstrap_state</code>, use <code>bootstrap</code> for regular clients or <code>ssh_bootstrap</code> for SSH clients.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The way the client retrieves the pillar data depends on the contact method you have chosen for your client:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you are using the <code>ssh-push-tunnel</code> contact method, ensure you have completed the remote port forwarding option.</p>
</li>
<li>
<p>If the client connects through a proxy, ensure you have completed the <code>ProxyCommand</code> option.
This depends on your proxy configuration, including how many proxies you need to connect through.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pillar data contains:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>mgr_server: The hostname of the Salt master</p>
</li>
<li>
<p>mgr_origin_server: The hostname of the SUSE Manager Server</p>
</li>
<li>
<p>minion_id: The hostname of the client to bootstrap</p>
</li>
<li>
<p>contact_method: The connection type</p>
</li>
<li>
<p>mgr_sudo_user: The user for <code>salt-ssh</code></p>
</li>
<li>
<p>activation_key: If selected</p>
</li>
<li>
<p>minion_pub: The pre-authorized public client key</p>
</li>
<li>
<p>minion_pem: The pre-authorized private client key</p>
</li>
<li>
<p>proxy_pub_key: The public SSH key that was retrieved from the proxy if the target is an SSH client and a proxy was selected</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The roster content contains:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hostname</code></p>
</li>
<li>
<p><code>user</code></p>
</li>
<li>
<p><code>password</code></p>
</li>
<li>
<p><code>port</code></p>
</li>
<li>
<p><code>remote_port_forwards</code>: the remote port forwarding SSH option</p>
</li>
<li>
<p><code>ssh_options</code>: other SSH options:</p>
<div class="ulist">
<ul>
<li>
<p><code>ProxyCommand</code> if the client connects through a proxy</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>timeout</code>: defaults to 180 seconds</p>
</li>
<li>
<p><code>ssh_pre_flight</code>: The path to the pre flight shell script (default: <code class="path">/usr/share/susemanager/salt-ssh/preflight.sh</code>)</p>
</li>
<li>
<p><code>ssh_pre_flight_args</code>: The list of arguments to call the pre flight script on the client</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This image provides an overview of the Salt SSH bootstrap process.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/salt-ssh-bootstrap-process.png" alt="salt ssh bootstrap process">
</div>
<div class="title">Figure 1. Salt SSH Bootstrap Process</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_proxy_support"><a class="anchor" href="#_proxy_support"></a><a class="link" href="#_proxy_support">8. Proxy Support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Salt SSH works with SUSE Manager Proxy  by chaining the SSH connection from one server or proxy to the next.
This is also known as a multi-hop or multi-gateway SSH connection.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/salt-ssh-proxy-multi-hop.png" alt="salt ssh proxy multi hop">
</div>
</div>
<div class="paragraph">
<p>SUSE Manager uses <code>ProxyCommand</code> to redirect SSH connections through proxies.
This options invokes an arbitrary command that is expected to connect to the SSH port on the target host.
The SSH process uses standard input and output of the command to communicate with the remote SSH daemon.</p>
</div>
<div class="paragraph">
<p><code>ProxyCommand</code> replaces a TCP/IP connection.
It does not perform any authorization or encryption.
Its role is simply to create a byte stream to the remote SSH daemon port.</p>
</div>
<div class="paragraph">
<p>This image depicts a client connecting to a server that is behind a gateway.
In this example <code>netcat</code> is used to pipe port 22 of the target host into the SSH standard input/output:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/salt-ssh-proxycommand.png" alt="salt ssh proxycommand">
</div>
</div>
<div class="paragraph">
<p>The Salt SSH calls run in this sequence when a proxy is in use:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>SUSE Manager initiates the SSH connection.</p>
</li>
<li>
<p><code>ProxyCommand</code> uses SSH to create a connection from the server to the client through the proxies.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This example uses <code>ProxyCommand</code> with two proxies and the <code>ssh-push</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># Connect the server to the first proxy:
/usr/bin/ssh -i /srv/susemanager/salt/salt_ssh/mgr_ssh_id -o StrictHostKeyChecking=no -o User=mgrsshtunnel  proxy1

# Connect the first proxy to the second, and forward standard input/output on the client to client:22 using the `-W` option:
/usr/bin/ssh -i /var/lib/spacewalk/mgrsshtunnel/.ssh/id_susemanager_ssh_push -o StrictHostKeyChecking=no -o User=mgrsshtunnel -W client:22  proxy2</pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/salt-ssh-push-push-plain-sequence.png" alt="salt ssh push push plain sequence">
</div>
</div>
<div class="paragraph">
<p>This example uses <code>ProxyCommand</code> with two proxies and the <code>ssh-push-tunnel</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># Connect the server to the first proxy:
/usr/bin/ssh -i /srv/susemanager/salt/salt_ssh/mgr_ssh_id -o User=mgrsshtunnel  proxy1

# Connect the first proxy to the second:
/usr/bin/ssh -i /home/mgrsshtunnel/.ssh/id_susemanager_ssh_push -o User=mgrsshtunnel  proxy2

# Connect the second proxy to the client and open an reverse tunnel (-R 1233:proxy2:443) from the client to the HTTPS port on the second proxy:
/usr/bin/ssh -i /home/mgrsshtunnel/.ssh/id_susemanager_ssh_push -o User=root -R 1233:proxy2:443 client

# Connect the client to itself and forward the standard input/output of the server to the SSH port of the client (-W client:22).
This is equivalent to `ssh ... proxy2 netcat client 22`` and is needed because SSH does not allow both the reverse tunnel (-R 1233:proxy2:443) and the standard input/output forward (-W client:22) in the same command.
/usr/bin/ssh -i /root/.ssh/mgr_own_id -W client:22 -o User=root client</pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/salt-ssh-push-push-tunnel-sequence.png" alt="salt ssh push push tunnel sequence">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_users_and_ssh_key_management"><a class="anchor" href="#_users_and_ssh_key_management"></a><a class="link" href="#_users_and_ssh_key_management">9. Users and SSH Key Management</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>To connect to a proxy, the parent server or proxy uses a specific user called <code>mgrsshtunnel</code>.
When <code>mgrsshtunnel</code> connects, the SSH configuration of the proxy will force the execution of <code>/usr/sbin/mgr-proxy-ssh-force-cmd</code>.
This is a simple shell script that allows only the execution of <code>scp</code>, <code>ssh</code>, or <code>cat</code> commands.</p>
</div>
<div class="paragraph">
<p>The connection to the proxy or client is authorized using SSH keys in this sequence:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The server connects to the client and to the first proxy using the key in <code>`/srv/susemanager/salt/salt_ssh/mgr_ssh_id</code>.</p>
</li>
<li>
<p>Each proxy has its own key pair in <code>`/home/mgrsshtunnel/.ssh/id_susemanager_ssh_push</code>.</p>
</li>
<li>
<p>Each proxy authorizes the key of the parent proxy or server.</p>
</li>
<li>
<p>The client authorizes its own key.</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/salt-ssh-push-ssh-keys.png" alt="salt ssh push ssh keys">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_repository_access_with_a_proxy"><a class="anchor" href="#_repository_access_with_a_proxy"></a><a class="link" href="#_repository_access_with_a_proxy">10. Repository Access with a Proxy</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>When SUSE Manager connects to a repository using a proxy, it can use either <code>ssh-push</code> or <code>ssh-push-tunnel</code>.</p>
</div>
<div class="paragraph">
<p>In both methods the client connects to the proxy to retrieve package and repository information.</p>
</div>
<div class="paragraph">
<p>In the <code>ssh-push</code> method, the package manager connects directly to the proxy using HTTP or HTTPS.
This works in cases where there is no firewall between the client and the proxy that blocks HTTP connections initiated by the client.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/salt-ssh-push-repo-access.png" alt="salt ssh push repo access">
</div>
</div>
<div class="paragraph">
<p>In the <code>ssh-push-tunnel</code> method, the HTTP connection to the proxy is redirected through a reverse SSH tunnel.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/salt-ssh-push-tunnel-repo-access.png" alt="salt ssh push tunnel repo access">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_proxy_setup"><a class="anchor" href="#_proxy_setup"></a><a class="link" href="#_proxy_setup">11. Proxy Setup</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>When the <code>spacewalk-proxy</code> package is installed on the proxy, the <code>mgrsshtunnel</code> user is created.</p>
</div>
<div class="paragraph">
<p>The initial configuration with <code>configure-proxy.sh</code> occurs using this sequence:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>An SSH key pair is generated, or an existing keypair is imported.</p>
</li>
<li>
<p>The SSH key of the parent server or proxy is retrieved to authorize it on the proxy.</p>
</li>
<li>
<p>The <code>ssh</code> daemon on the proxy is configured to restrict the <code>mgrsshtunnel</code> user.
This is done by the <code>mgr-proxy-ssh-push-init</code> script, which is called from <code>configure-proxy.sh</code>.
It does not have to be manually invoked.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The parent key is retrieved by calling an HTTPS endpoint on the parent server or proxy.
The first endpoint tried is <code><a href="https://$PARENT/pub/id_susemanager_ssh_push.pub" class="bare">https://$PARENT/pub/id_susemanager_ssh_push.pub</a></code>.
If the parent is a proxy then this will return the public SSH key of the proxy.</p>
</div>
<div class="paragraph">
<p>If a 404 error is received from that endpoint, then the parent is assumed to be a server not a proxy, and <code><a href="https://$PARENT/rhn/manager/download/saltssh/pubkey" class="bare">https://$PARENT/rhn/manager/download/saltssh/pubkey</a></code> is tried instead.</p>
</div>
<div class="paragraph">
<p>If an SSH key exists at <code>/srv/susemanager/salt/salt_ssh/mgr_ssh_id.pub</code> on the server it is returned.</p>
</div>
<div class="paragraph">
<p>If the public key does not exist because <code>salt-ssh</code> has not been invoked yet, a key will be generates by calling the <code>mgrutil.ssh_keygen</code> runner.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Salt SSH generates a keypair the first time it is invoked with <code>/srv/susemanager/salt/salt_ssh/mgr_ssh_id</code>.
The sequence in this section is needed if a proxy is configured before Salt SSH was invoked for the first time.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="salt-formulas-custom.html">Custom Salt Formulas</a></span>
  <span class="next"><a href="salt-rate-limiting.html">Rate Limiting</a></span>
</nav>
</article>
  </div>
</main>
</div>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../.." data-snippet-length="100" data-stylesheet="../../../_/css/search.css"></script>
<script async src="../../../search-index.js"></script>
<script src="../../../_/js/vendor/langSelection.js"></script>

  </body>
</html>
