[[retail.deploy_terminals_other]]
= Deploy Terminals - Other Methods


If you are not able to boot terminals from the network, you can create a live USB image and deploy terminals using a removable USB storage device.

You can also bootstrap terminals across a wireless network.

[IMPORTANT]
====
After you have registered new terminals, always check the {susemgr} {webui} to ensure your terminals have connected successfully to the branch server, and not directly to the {susemgr} Server by mistake.
====



== Deploy Terminals with a Removable USB Device

If you do not want to boot terminals from the network, you can create a live USB image and deploy terminals using a removable USB storage device.
This is useful if you cannot boot your terminals from the network, or if you do not have a local {smr} branch server providing network services.

You can prepare a bootable USB device with the image and tools required to deploy a POS terminal using a remote {smr} branch server.
POS devices booted using the USB device are assigned to the {smr} branch server that created the USB device.

You can create the bootable USB device on the branch server directly, or on the {smr} Server.



.Procedure: Creating a Bootable USB Device
. On the {smr} branch server, at the command prompt, as root, create the POS image.
You need to specify the size of the image, in megabytes.
Ensure you allow at least 300{nbsp}MB:
+
----
salt-call image_sync_usb.create <usb image name> <size in MB>
----
. Insert the USB device into the {smr} branch server machine, and copy the image to the new location:
+
----
dd if=<usb image name> of=<path to usb device>
----


When you have the image on the USB drive, check that the terminals you want to deploy allow local booting.
You can check this by editing the Saltboot formula in the {smr} {webui}.
For more information about the Saltboot formula, see xref:salt:formula-saltboot.adoc[].



.Procedure: Deploying Images to the Terminals using USB
. Insert the USB device into the terminal.
. Power on the POS terminal.
. Boot from the USB device to begin bootstrapping.



== Bootstrap Terminals over a Wireless Network

For terminals that cannot be connected directly to the physical network, you can bootstrap them over a wireless network.
Wireless networks do not support PXE booting, so you must perform the initial booting and initialization of the wireless connection on the terminal using a USB device.

For more information about using USB devices to boot, see xref:retail:retail-deploy-terminals-other.adoc[].


[[WARNING]]
====
Bootstrapping across a wireless network could expose a security risk if you are using encrypted OS images.
The boot ``initrd`` image and the partition that contains ``/etc/salt`` must be stored unencrypted on the terminal.
This allows {smr} to set up the wireless network.
If this breaches your security requirements, you will need to use a separate production network, with network credentials managed by Salt, so that credentials are not stored on the terminal unencrypted.
====


.Procedure: Preparing Wireless-Enabled Boot Image
. Ensure that the ``dracut-wireless`` package is included  in the image template.
. Provide the wireless credentials using the [command]``WIRELESS_ESSID`` and [command]``WIRELESS_WPA_PSK`` kernel options.
. OPTIONAL: If you use the same wireless credentials for the entire organization, you can set them permanently by creating or editing the ``etc/sysconfig/network/ifcfg-wlan0`` file to the image template, with these details:
+
----
# ALLOW_UPDATE_FROM_INITRD
WIRELESS_ESSID=<wireless network name>
WIRELESS_WPA_PSK=<wireless network password>
----
If you want to use different credentials for bootstrapping to what is used during normal operation, you can remove the ``ALLOW_UPDATE_FROM_INITRD`` line.
. Build the image.
. Prepare a USB device using this image, and boot the terminal.
For more information about using USB devices to boot, see xref:retail:retail-deploy-terminals-other.adoc[].

Alternatively, you can create the file and add it to the ``initrd``:
+
----
echo ./etc/sysconfig/network/ifcfg-wlan0 | cpio -H newc -o | gzip >> /srv/saltboot/boot/initrd.gz
----

Check that the terminals you want to deploy allow local booting.
You can check this by editing the Saltboot formula in the {smr} {webui}.
For more information about the Saltboot formula, see xref:salt:formula-saltboot.adoc[].



=== Change Wireless Credentials

After you have set the wireless credentials, you can change them as needed.
The way to do this is different if you use one company-wide network, if you have each branch server on its own seperate network, or if you are using different wireless networks for booting and for regular system use.



.Procedure: Changing Wireless Credentials for Single Network
. Rebuild the boot image with updated credentials.
. Recreate the bootable USB device based on the new boot image.
. Boot terminal from new USB device.



.Procedure: Changing Wireless Credentials for Multiple Networks
. In the [path]``/srv/salt/`` directory, create a salt state called ``update-terminal-credentials.sls``, and copy the details from [path]``/etc/sysconfig/network/ifcfg-wlan0``.
At a command prompt on the terminal:
+
----
/etc/sysconfig/network/ifcfg-wlan0
  file.managed:
   - contents: |
        WIRELESS_ESSID=<wireless_network_name>
        WIRELESS_WPA_PSK=<wireless_network_password>
# regenerate initrd
  cmd.run:
  - name: 'mkinitrd'
----
. Apply the Salt state to the terminal:
+
----
salt <terminal_salt_name> state.apply update-terminal-credentials
----

[[NOTE]]
====
If you are using a separate network for the boot phase, the managed file might need to be renamed, or extended to [path]``/etc/sysconfig/network/initrd-ifcfg-wlan0``.
====



You can also instruct terminals to use a different set of wireless credentials during the boot process, to what they use during normal operation.
This is done by using custom Salt states.



.Procedure: Using Different Wireless Credentials for Booting
. Write a custom Salt state named ``saltboot_hook`` to provide a custom Salt state called ``/etc/sysconfig/network/ifcfg-wlan0`` to the system image during boot:
+
----
{% set root = salt['environ.get']('NEWROOT') %}
{{ root }}/etc/sysconfig/network/ifcfg-wlan0:
  file.managed:
    - source:
      - <salt://any/file>
    - require:
      - saltboot: saltboot_fstab
    - require_in:
      - saltboot: boot_system
----
The hook is applied after the system image is deployed.
. Create a different version for use during booting, called ``/etc/sysconfig/network/initrd-ifcfg-wlan0``.
This file can be maintained by Salt on running terminals, to provide wireless credentials for use only during bootstrap and booting.


[[NOTE]]
====
The boot phase supports only WPA2 PSK wireless configuration.
Salt-managed production configuration supports all features supported by all major operating systems.
====
