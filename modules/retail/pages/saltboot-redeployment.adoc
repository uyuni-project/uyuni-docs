[[retail.deploy.force_redeployment]]
= Force saltboot image redeployment

Systems provisioned by Saltboot are usually redeployed or repartitioned automatically when a new image is available or Saltboot partitioning changes.

Occasionally, however, it is needed to force Saltboot to redeploy an image or repartition disk even when automation would not do so.
For these situations, Saltboot offers three ways to force redeployment or repartitioning:

* Force redeployment using salt grains
* Force redeployment using custom info values
* Force redeployment using salt pillars

[WARNING]
====
Repartitioning of a terminal removes all data stored on the terminal hard disk, including any persistent partitions.
====

== Force Saltboot redeployment using {salt} grains

Saltboot redeployment grains have no side effects and do not require any further configuration.
Limitation is that terminal must be accessible by [systeminfo]``salt``.

.Procedure: Forcing a Saltboot to Redeploy Image
. On the {productname} Server, at the command prompt, as root, apply this Salt state:
+
----
salt $terminal_minion_id state.apply saltboot.force_redeploy
----
. Restart the terminal to pick up the changes.


.Procedure: Forcing a Saltboot to Repartition the Hard Disk
. On the {productname} Server, at the command prompt, as root, apply this Salt state:
+
----
salt $terminal_minion_id state.apply saltboot.force_repartition
----
. Restart the terminal to pick up the changes.

== Force saltboot redeployment using custom info values

Saltboot custom values removes the limitation on terminal being reachable by [systemitem]``salt``, however there are configuration steps.

Custom Info keys and values can be also managed using API or [systemitem]``spacecmd`` command.
For more information, see xref:reference:spacecmd/custominfo.adoc[].

.Procedure: Create custom info key for image redeployment
. In the {productname} {webui}, navigate to menu:Systems[Custom System Info].
. Click [guimenu]``Create Key`` to create new [systemitem]``Custom Info Key``.
. As [guimenu]``Key Label`` fill in [systemitem]``saltboot_force_redeploy``.
. As [guimenu]``Description`` fill in [systemitem]``Force redeploy saltboot image``.
. Click [guimenu]``Create Key``.

[NOTE]
====
Creating [systemitem]``saltboot_force_redeploy`` custom key is a one time operation.
When created, it is available for repeated use.
====

.Procedure: Assign custom value for image redeployment
. Navigate to the [guimenu]``Overview`` page of the system you want to redeploy
. Select tab [guimenu]``Custom Info``
. Click on [guimenu]``Create Value``
. From the list of available keys click [guimenu]``saltboot_force_redeploy``.
. As [guimenu]``Value`` type [systemitem]``True``.
. Click [guimenu]``Update Key``.
. Reboot the terminal to pick up the changes.

[INFO]
====
After terminal finishes booting, saltboot redeployment custom info setting is automatically reset to prevent repeated redeployment.
====

.Procedure: Create custom info key for disk repartitioning
. Navigate to menu::Systems[Custom System Info] page
. Click [guimenu]``Create Key`` to create new [systemitem]``Custom Info Key``
. As [guimenu]``Key Label`` fill in [systemitem]``saltboot_force_repartition``
. As [guimenu]``Description`` fill in `Force terminal disk repartition`
. Click [guimenu]``Create Key``

[INFO]
====
Creating [systemitem]``saltboot_force_repartition`` custom key is one time operation. Once created, it is available for repeated use.
====

.Procedure: Assign custom value for image redeployment
. Follow the redeployment procedure, but select [guimenu]``saltboot_force_repartition`` key in step 4

== Force saltboot redeployment using saltboot formula

Saltboot redeployment formula data has a significant side effect in terms of using [systemitem]``saltboot formula`` on the system level. This will probably mask further changes of [systemitem]``saltboot formula`` on group level unless formula is manually unassigned from the terminal.

[WARNING]
====
Usually saltboot formula is assigned to the hardware type group and data visible on system level are inherited from this group.
Saving group formula on system level will cause data from group to be copied to the system.

This has the side effect that changes on group level, like hardware type group formula, will not be visible on system level unless system level formula is unassigned from the system.
====

[NOTE]
====
After terminal finishes booting, saltboot redeployment formula setting is automatically reset to prevent repeated redeployment.
====

.Procedure: Forcing a Saltboot to Redeploy Image using Saltboot formula
. Select the [guimenu]``Formulas`` tab for the system you want to redeploy.
. Select Saltboot formula.
. At the bottom check [guimenu]``Force image redeployment`` checkbox.
. Save the formula.
. Reboot the terminal to pick up the changes.

If your terminal encounters a problem with the file system or the partition table, you might need to remove the partition table and reformat the terminal.
Follow the procedure for image redeployment, but instead check [guimenu]``Force disk repartition`` checkbox.
