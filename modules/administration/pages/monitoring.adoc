[[monitoring]]
= Monitoring with Prometheus and Grafana

You can monitor your {productname} environment using Prometheus and Grafana.
{productname} Server and Proxy are able to provide self-health metrics.
You can also install and manage a number of Prometheus exporters on Salt clients.

Prometheus and Grafana packages are included in the {productname} Client Tools for {sle}{nbsp}12, {sle}{nbsp}15 and openSUSE 15.x.

You need to install Prometheus and Grafana on a machine separate from the {productname} Server.
We recommend you use a managed Salt client as your monitoring server.

[NOTE]
====
Prometheus fetches metrics using a pull mechanism, so the server must be able to establish TCP connections to monitored clients.
Clients must have corresponding open ports and be reachable over the network.
====

== Prometheus and Grafana

.Prometheus

Prometheus is an open-source monitoring tool that is used to record real-time metrics in a time-series database.
Metrics are pulled via HTTP, enabling high performance and scalability.

Prometheus metrics are time series data, or timestamped values belonging to the same group or dimension.
A metric is uniquely identified by its name and set of labels.

// TODO:: This should be an actual image.

----
   metric name               labels                 timestamp     value
┌────────┴───────┐  ┌───────────┴───────────┐    ┌──────┴──────┐  ┌─┴─┐
http_requests_total{status="200", method="GET"}  @1557331801.111  42236
----

Each application or system being monitored must expose metrics in the format above, either through code instrumentation or Prometheus exporters.

.Prometheus Exporters

Exporters are libraries that help with exporting metrics from third-party systems as Prometheus metrics.
Exporters are useful whenever it is not feasible to instrument a given application or system with Prometheus metrics directly.
Multiple exporters can run on a monitored host to export local metrics.

The Prometheus community provides a list of official exporters, and more can be found as community contributions.
For more information and an extensive list of exporters, see https://prometheus.io/docs/instrumenting/exporters/.

.Grafana

Grafana is a tool for data visualization, monitoring, and analysis.
It is used to create dashboards with panels representing specific metrics over a set period of time.
Grafana is commonly used together with Prometheus, but also supports other data sources such as ElasticSearch, MySQL, PostgreSQL, and Influx DB.
For more information about Grafana, see https://grafana.com/docs/.

== Set up the Monitoring Server

=== Install Prometheus

If your monitoring server is a {productname} Salt client, you can install the Prometheus package using the {productname} {webui}.
Otherwise you can download and install the package on your monitoring server manually.

.Procedure: Installing Prometheus using the {webui}

. In the {productname} {webui}, open the details page of the system where Prometheus is to be installed, and navigate to the [guimenu]``Formulas`` tab.
. Check the [guimenu]``Prometheus`` checkbox to enable  monitoring formulas, and click btn:[Save].
. Navigate to the ``Prometheus`` tab in the top menu.
. In the ``{productname} Server`` section, enter valid {productname} API credentials.
Make sure that the credentials you have entered allow access to the set of systems you want to monitor.
. Customize any other configuration options according to your needs.
. Click btn:[Save Formula].
. Apply the highstate and confirm that it completes successfully.
. Check that the Prometheus interface loads correctly. In your browser, navigate to the URL of the server where Prometheus is installed, on port 9090 (for example, [literal]``http://example.com:9090``).

.Procedure: Manually installing and configuring Prometheus
. On the monitoring server, install the [package]``golang-github-prometheus-prometheus`` package:
+
----
zypper in golang-github-prometheus-prometheus
----
. Enable the Prometheus service:
+
----
systemctl enable --now prometheus
----
. Check that the Prometheus interface loads correctly.
In your browser, navigate to the URL of the server where Prometheus is installed, on port 9090 (for example, [literal]``http://example.com:9090``).

. Open the configuration file at [path]``/etc/prometheus/prometheus.yml`` and add this configuration information.
Replace `server.url` with your {productname} server URL and adjust `username` and `password` fields to match your {productname} credentials.
+
----
# {productname} self-health metrics
scrape_configs:
- job_name: 'mgr-server'
  static_configs:
    - targets:
      - 'server.url:9100'  # Node exporter
      - 'server.url:9187'  # PostgreSQL exporter
      - 'server.url:5556'  # JMX exporter (Tomcat)
      - 'server.url:5557'  # JMX exporter (Taskomatic)
      - 'server.url:9800'  # Taskomatic
    - targets:
      - 'server.local :80'    # Message queue
      labels:
        __metrics_path__: /rhn/metrics

# Managed systems metrics:
- job_name: 'mgr-clients'
  uyuni_sd_configs:
   - host: "http://server.url"
     username: "admin"
     password: "admin"
----

. Save the configuration file.
. Restart the Prometheus service:
+
----
systemctl restart prometheus
----

[NOTE]
====
For more information about the Prometheus configuration options, see the official Prometheus documentation at https://prometheus.io/docs/prometheus/latest/configuration/configuration/
====

=== Install Grafana

If your monitoring server is a {productname} Salt client, you can install the Grafana package using the {productname} {webui}.
Otherwise you can download and install the package on your monitoring server manually.

.Procedure: Installing Grafana via {productname} {webui}

. In the {productname} {webui}, open the details page of the system where Grafana is to be installed, and navigate to the [guimenu]``Formulas`` tab.
. Check the [guimenu]``Grafana`` checkbox to enable  monitoring formulas, and click btn:[Save].
. Navigate to the ``Grafana`` tab in the top menu.
. In the ``Enable and configure Grafana`` section, enter the admin credentials you want to use to log in Grafana.
. On the ``Datasources`` section, make sure that the Prometheus URL field points to the system where Prometheus is running.
. Customize any other configuration options according to your needs.
. Click btn:[Save Formula].
. Apply the highstate and confirm that it completes successfully.
. Check that the Grafana interface is loading correctly. In your browser, navigate to the URL of the server where Grafana is installed, on port 3000 (for example, [literal]``http://example.com:3000``).

[NOTE]
====
{productname} provides pre-built dashboards for server self-health, basic client monitoring, and more.
You can choose which dashboards to provision in the formula configuration page.
====

.Procedure: Manually installing Grafana

. Install the [package]``grafana`` package:
+
----
zypper in grafana
----
. Enable the Grafana service:
+
----
systemctl enable --now grafana-server
----
. Check that the Grafana interface is loading correctly.
In your browser, navigate to the URL of the server where Grafana is installed, on port 3000 (for example, [literal]``http://example.com:3000``).

image::monitoring_grafana_example.png[scaledwidth=80%]

For more information on how to manually install and configure Grafana, see https://grafana.com/docs.

== Configure {productname} Monitoring

With {productname}{nbsp}4, you can enable the server to expose Prometheus self-health metrics, and also install and configure exporters on client systems.

=== Server Self Monitoring

The Server self-health metrics cover hardware, operating system and {productname} internals.
These metrics are made available by instrumentation of the Java application, combined with Prometheus exporters.

These exporter packages are shipped with {productname} Server:

* Node exporter: [systemitem]``golang-github-prometheus-node_exporter``.
See https://github.com/prometheus/node_exporter.
* PostgreSQL exporter: [systemitem]``golang-github-wrouesnel-postgres_exporter``.
See https://github.com/wrouesnel/postgres_exporter.
* JMX exporter: [systemitem]``prometheus-jmx_exporter``.
See https://github.com/prometheus/jmx_exporter.
* Apache exporter: [systemitem]``golang-github-lusitaniae-apache_exporter``.
See https://github.com/Lusitaniae/apache_exporter.

These exporter packages are shipped with {productname} Proxy:

* Node exporter: [systemitem]``golang-github-prometheus-node_exporter``.
See https://github.com/prometheus/node_exporter.
* Squid exporter: [systemitem]``golang-github-boynux-squid_exporter``.
See https://github.com/boynux/squid-exporter.

The exporter packages are pre-installed in {productname} Server and Proxy, but their respective systemd daemons are disabled by default.

.Procedure: Enabling Self Monitoring

. In the {productname} {webui}, navigate to menu:Admin[Manager Configuration > Monitoring].
. Click btn:[Enable services].
. Restart Tomcat and Taskomatic.
. Navigate to the URL of your Prometheus server, on port 9090 (for example, [literal]``http://example.com:9090``)
. In the Prometheus UI, navigate to menu:[Status > Targets] and confirm that all the endpoints on the ``mgr-server`` group are up.
. If you have also installed Grafana with the {webui}, the server insights will be visible on the {productname} Server dashboard.

image::monitoring_enable_services.png[scaledwidth=80%]

[IMPORTANT]
====
Only server self-health monitoring can be enabled using the {webui}.
Metrics for a proxy are not automatically collected by Prometheus.
To enable self-health monitoring on a proxy, you will need to manually install exporters and enable them.
====

=== Monitoring Managed Systems

Prometheus metrics exporters can be installed and configured on Salt clients using formulas.
The packages are available from the {productname} client tools channels, and can be enabled and configured directly in the {productname} {webui}.

These exporters can be installed on managed systems:

* Node exporter: [systemitem]``golang-github-prometheus-node_exporter``.
See https://github.com/prometheus/node_exporter.
* PostgreSQL exporter: [systemitem]``golang-github-wrouesnel-postgres_exporter``.
See https://github.com/wrouesnel/postgres_exporter.
* Apache exporter: [systemitem]``golang-github-lusitaniae-apache_exporter``.
See https://github.com/Lusitaniae/apache_exporter.

When you have the exporters installed and configured, you can start using Prometheus to collect metrics from monitored systems.
If you have configured your monitoring server with the {webui}, metrics collection will happen automatically.

.Procedure: Configuring Prometheus Exporters on a Client

. In the {productname} {webui}, open the details page of the client to be monitored, and navigate to the menu:Formulas tab.
. Check the [guimenu]``Enabled`` checkbox on the ``Prometheus Exporters`` formula.
. Click btn:[Save].
. Navigate to the menu:Formulas[Prometheus Exporters] tab.
. Select the exporters you want to enable and customize arguments according to your needs.
. Click btn:[Save Formula].
. Apply the highstate.

image::monitoring_configure_formula.png[scaledwidth=80%]

[NOTE]
====
Monitoring formulas can also be configured for System Groups, by applying the same configuration used for individual systems inside the corresponding group.
====



=== Network Boundaries

Scrape targets must be accessible from the Prometheus server. 
For clients installed on cloud instances, the simplest approach is to add the required ports into a security group that has access to the monitoring server. 
Shipped exporters use these ports: 

* Node exporter: 9100
* PostgreSQL exporter: 9187
* Apache exporter: 9117

Another approach is to deploy a Prometheus instance in the network local to the exporters and configure federation. This will allow the main monitoring server to scrape time series from the local Prometheus instance. In this setup only Prometheus API port (9090) has to be opened.

For more information on about Prometheus federation, see https://prometheus.io/docs/prometheus/latest/federation/.

Finally, in some cases it is reasonable to proxy the the requests through the network boundary. Tools like PushProx deploy a proxy and a client on both sides of the network barrier and allow seamless Promethes operation across NAT or other similar network topologies.

For more information on PushProx, see https://github.com/RobustPerception/PushProx.
