[[contact-methods-pushssh]]
= Push via Salt SSH (with tunnel)


Push via SSH (with tunnel) is used in environments where clients cannot reach the {productname} Server directly.
In this environment, clients are located in a firewall-protected zone called a DMZ.
No system within the DMZ is authorized to open a connection to the internal network, including the {productname} Server.

This SSH method creates an encrypted tunnel from the {productname} Server on the internal network to the clients located on the DMZ.
After all actions and events are executed, the tunnel is closed.

The server uses SSH to contact the clients at regular intervals, checking in and performing scheduled actions and events.



[IMPORTANT]
====
Re-installing systems using the provisioning model is not currently supported on clients managed with Push via SSH.
====


[IMPORTANT]
====
The tunnel is used to provide the access to the server through the encrypted tunnel.
the repositories assigned to the salt-ssh client with the tunnel are provided through this tunnel only, thus it is not possible to use package manager tools directly from the system because the repositories are available only while the tunnel is up.
In other words, access is only possible if the session is initiated by the server.
All package managing operations on the client can be performed from the server side only.
====

For tunneling connections via SSH, a port number is required for tunneling via HTTPS.
The port number used by default is `1233`.
To overwrite it, you can add a custom port numbers greater than 1024 to [path]``/etc/rhn/rhn.conf``:

----
ssh_push_port_https = high_port
----


For security reasons, you might want to use sudo with SSH, to access the system as an unprivileged user instead of as root.


.Procedure: Configuring Unprivileged SSH Access
. Ensure you have the latest [path]``spacewalk-taskomatic`` and [path]``spacewalk-certs-tools`` packages installed on the {productname} Server.
. On each client system, create an appropriate unprivileged user.
. On each client system, edit the [filename]``sudoers`` file:
+
----
sudo visudo
----
. Grant [command]``sudo`` access to the user by adding this line at the end of the [filename]``sudoers`` file.
  Replace [systemitem]``<user>`` with the name of the user that is bootstrapping the client in the {webui}:
+
----
<user>  ALL=NOPASSWD: /usr/bin/python, /usr/bin/python2, /usr/bin/python3, /var/tmp/venv-salt-minion/bin/python
----
+
[NOTE]
====
This procedure grants root access without requiring a password, which is required for registering the client.
When the client is successfully installed it runs with root privileges, so the access is no longer required.
We recommend that you remove the line from the [path]``sudoers`` file after the client has been successfully installed.
====

. On each client system, in the [path]``/home/<user>/.bashrc`` file, add these lines:
+
----
PATH=$PATH:/usr/sbin
export PATH
----
. On the {productname} Server, in the [path]``/etc/rhn/rhn.conf`` configuration file, add or amend this line to include the unprivileged username:
+
----
ssh_push_sudo_user = <user>
----


Because clients are in the DMZ and cannot reach the server, you need to use the [command]``mgr-ssh-push-init`` tool to register them with the {productname} Server.

To use the tool, you need the client hostname or IP address, and the path to a valid bootstrap script on the {productname} Server.
For more information about bootstrapping, see xref:client-configuration:registration-bootstrap.adoc[].

The bootstrap script needs to have an activation key associated with it that is configured for Push via SSH.
For more information on activation keys, see xref:client-configuration:activation-keys.adoc[].

Before you begin, you need to ensure that you have specified which ports to use for SSH tunneling.
If you have registered clients before changing the port numbers, they need to be registered again.




.Example: API Access to Push via SSH

You can use the API to manage which contact method to use.
This example Python code sets the contact method to ``ssh-push``.

Valid values are:

* `default` (pull)
* `ssh-push`
* `ssh-push-tunnel`

----
client = xmlrpclib.Server(SUMA_HOST + "/rpc/api", verbose=0)
key = client.auth.login(SUMA_LOGIN, SUMA_PASSWORD)
client.system.setDetails(key, 1000012345, {'contact_method' : 'ssh-push'})
----
