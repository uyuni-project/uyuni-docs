[[salt-state-modules]]
= Configuration State Modules

Salt execution modules are the functions called by the salt command.

{productname} provide a set of execution modules to configure organizations, users, user permissions on channels and system groups.
Those are provided in a form of a package which contains the salt state modules and set of examples.

For more information on execution and how to use them, see https://docs.saltstack.com/en/latest/topics/tutorials/modules.html.

== Installations instruction
To install these states a user should install the following package on the {productname} server:

`zypper in susemanager-config-modules`

For more information check the state implementation on `/usr/share/susemanager/salt/_modules/uyuni_config.py`

== Pillar data structure global Admin User

Default administrator user can be defined in pillar data and in this way avoid duplication.
To do so, one should specify the following data:

[source]
----
uyuni:
  xmlrpc:
    user: desired_username
    password: desired_password
----

== Available Modules

=== channel_list_manageable_channels
**(uid, password)**

List with all of manageable channels for the authenticated user

....
uid: user login id
password: user password
....

    return: list of manageable channels for the user

=== channel_list_my_channels
**(uid, password)**

List with all of subscribed channels for the authenticated user

....
uid: user login id
password: user password
....

    return: list of subscribed channels for the user

=== channel_software_is_globally_subscribable
**(channel_label, org_admin_user=None, org_admin_password=None)**

Verify if whether the channel is globally subscribed on the organization

....
channel_label: channel's label
org_admin_user: organization admin username
org_admin_password: organization admin password
....

    return: boolean which indicates if channel is globally subscribe

=== channel_software_is_user_manageable
**(channel_label, uid, admin_user=None, admin_password=None)**

Verify whether the channel may be managed by the given user.

....
channel_label: channel's label
uid: user login id
admin_user: organization admin username
admin_password: organization admin password
....

    return: boolean which indicates if user can manage channel or not

=== channel_software_is_user_subscribable
**(channel_label, uid, org_admin_user=None, org_admin_password=None)**

Verify whether the channel may be managed by the given user.

....
channel_label: channel's label
uid: user login id
org_admin_user: organization admin username
org_admin_password: organization admin password
....

    return: boolean which indicates if user subscribe the channel or not

=== channel_software_set_user_manageable
**(channel_label, uid, access, admin_user=None, admin_password=None)**

Set the manageable flag for a given channel and user.
If access is set to 'true', this method will give the user manage permissions to the channel.
Otherwise, that privilege is revoked.

....
channel_label: channel's label
uid: user login id
access: Flag which if user should have access to channel or not
admin_user: organization admin username
admin_password: organization admin password
....

    return: boolean indication success in operation


=== channel_software_set_user_subscribable
(channel_label, uid, access, admin_user=None, admin_password=None)

Set the subscribable flag for a given channel and user.
If value is set to 'true', this method will give the user subscribe permissions to the channel.
Otherwise, that privilege is revoked.

....
channel_label: channel's label
uid: user login id
access: Flag which if user should subscribe a channel or not
admin_user: organization admin username
admin_password: organization admin password
....

    return: boolean indication success in operation

=== master_list_minions
**(active=False)**

Obtain a list of all available minions from the configured Salt Master on the same host.

....
active: Return only active minions.
....

    return: list of minion IDs

=== master_select_minions
**(target=None, target_type='glob')**

Return list minions from the configured Salt Master on the same host which match the target expression on the defined target

....
target: target expression to filter minions
target_type: target type, one of the following: glob, grain, grain_pcre, pillar, pillar_pcre,
     pillar_exact, compound, compound_pillar_exact. Default: glob.
....

    return: list of minion IDs

=== org_create
** (name, org_admin_user, org_admin_password, first_name, last_name, email, admin_prefix='Mr.', pam=False, admin_user=None, admin_password=None)**

Create organization. Admin user must have Administrator role to perform this action.

....
name: organization name
org_admin_user: organization admin user
org_admin_password: organization admin password
first_name: organization admin first name
last_name: organization admin last name
email: organization admin email
admin_prefix: organization admin prefix
pam:organization admin pam authentication
admin_user: admin user
admin_password: admin password
....

    return: dictionary with organization information

=== org_delete
**(name, admin_user=None, admin_password=None)**

Delete organization. Admin user must have Administrator role to perform this action.

....
name: organization name
admin_user: admin user
admin_password: admin password
....

    return: None

=== org_get_details
**(name, admin_user=None, admin_password=None)**

Get organization details. Admin user must have Administrator role to perform this action.

....
name: organization name
admin_user: admin user
admin_password: admin password
....

    return: None

== org_list_orgs
**(admin_user=None, admin_password=None)**

List all existing organizations. Admin user must have Administrator role to perform this action.

....
admin_user: admin user
admin_password: admin password
....

    return: list of all available orgs.

=== org_trust_add_trust
**(org_id, org_trust_id, admin_user=None, admin_password=None)**

Add an organization to the list of trusted organizations.
admin_user needs to have Administrator role to perform this action.

....
org_id: Organization id
org_trust_id: Trust organization id
admin_user: admin user
admin_password: admin password
....
    return: None

=== org_trust_add_trust_by_name
**(org_name, org_trust, admin_user=None, admin_password=None)**

Add an organization to the list of trusted organizations.
admin_user needs to have Administrator role to perform this action.

....
org_name: organization name
org_trust: Trust organization name
admin_user: admin user
admin_password: admin password
....

    return: None

=== org_trust_list_orgs
**(admin_user=None, admin_password=None)**

List all organanizations trusted by the authenticated user organization.

....
admin_user: admin user
admin_password: admin password
....

    return: None

=== org_trust_list_trusts
**(org_name, admin_user=None, admin_password=None)**

List all trusts for one organization.
admin_user needs to have  Administrator role to perform this action.

....
org_name: Name of the organization to get the trusts
admin_user: admin user
admin_password: admin password
....

    return: list of all organizations with the trust flag value

=== org_trust_remove_trust
**(org_id, org_untrust_id, admin_user=None, admin_password=None)**

Remove an organization to the list of trusted organizations.
admin_user needs to have Administrator role to perform this action.

....
org_id: orgnization id
org_untrust_id: organizaton id to untrust
admin_user: admin user
admin_password: admin password
....

    return: None

=== org_trust_remove_trust_by_name
**(org_name, org_untrust, admin_user=None, admin_password=None)**

Remove an organization to the list of trusted organizations.
admin_user needs to have Administrator role to perform this action.

....
org_name: organization name
org_untrust: organization name to untrust
admin_user: admin user
admin_password: admin password
....

    return: None

=== org_update_name
**(org_id, name, admin_user=None, admin_password=None)**

Update organization name.

....
org_id: Organization id
name: new organization name
admin_user: admin user
admin_password: admin password
....

    return: None

=== systemgroup_add_remove_systems
**(name, add_remove, system_ids=[], org_admin_user=None, org_admin_password=None)**

Update system group.

....
name: Name of the system group.
add_remove: True to add to the group, False to remove.
system_ids: list of system ids to add/remove from group
org_admin_user: organization administrator username
org_admin_password: organization administrator password
....

    return: 1 on success, exception thrown otherwise.

=== systemgroup_create
**(name, descr, org_admin_user=None, org_admin_password=None)**

Create system group.

....
name: Name of the system group.
descr: Description of the system group.
org_admin_user: organization administrator username
org_admin_password: organization administrator password
....

    return: system group

=== systemgroup_delete
**(name, org_admin_user=None, org_admin_password=None)**

Delete system group.

....
name: Name of the system group
org_admin_user: organization administrator username
org_admin_password: organization administrator password
....

    return: 1 on success, exception thrown otherwise.

=== systemgroup_get_details
**(name, org_admin_user=None, org_admin_password=None)**

Get system group details

....
name: Name of the system group
org_admin_user: organization administrator username
org_admin_password: organization administrator password
....

    return: system group

=== systemgroup_list_systems
**(name, minimal=True, org_admin_user=None, org_admin_password=None)**

List system on system group

....
name: Name of the system group.
minimal: default True. Minimal information or more detailed one about systems
org_admin_user: organization administrator username
org_admin_password: organization administrator password
....

    return: List of system information

=== systemgroup_update
**(name, descr, org_admin_user=None, org_admin_password=None)**

Update system group description

....
name: Name of the system group.
descr: Description of the system group.
org_admin_user: organization administrator username
org_admin_password: organization administrator password
....

    return: server group structure.

=== systems_get_minion_id_map
**(username=None, password=None, refresh=False)**

Map between minion ID and system internal ID of all system user have access to

....
username: username to authenticate
password: password for user
refresh: Get new data from server, ignoring values in local context cache
....

    return: Map between minion ID and system ID of all system accessible by authenticated user

=== user_add_assigned_system_groups
**(uid, server_group_names, set_default=False, org_admin_user=None, org_admin_password=None)**

Add system groups to user's list of assigned system groups.
If no organization admin credentials are provided, credentials from pillar are used

....
uid: user id to look for
server_group_names: systems groups to add to list of assigned system groups
set_default: Should system groups also be added to user's list of default system groups.
org_admin_user: organization admin username
org_admin_password: organization admin password
....

    return: boolean indication success in operation

=== user_add_role
**(uid, role, org_admin_user=None, org_admin_password=None)**

Add role to user in Uyuni.
If no organization admin credentials are provided, credentials from pillar are used.

....
uid: user id to look for
role: role to be added to the user
org_admin_user: organization admin username
org_admin_password: organization admin password
....
    return: boolean indication success in operation

=== user_create
**(uid, password, email, first_name, last_name, use_pam_auth=False, org_admin_user=None, org_admin_password=None)**

Create user if it doesn't exist already.
If no organization admin credentials are provided, credentials from pillar are used.

....
uid: user id to look for
password: password for the user
email: user email address
first_name: user first name
last_name: user last name
use_pam_auth: if you wish to use PAM authentication for this user
org_admin_user: organization admin username
org_admin_password: organization admin password
....

    return: boolean indication success in operation

=== user_delete
**(uid, org_admin_user=None, org_admin_password=None)**

Delete user if exists.
If no organization admin credentials are provided, credentials from pillar are used.

....
uid: user id to look for
org_admin_user: organization admin username
org_admin_password: organization admin password
....
    return: boolean indication success in operation

=== user_get_details
**(uid, password=None, org_admin_user=None, org_admin_password=None)**

Get user information..
If user password is provided name and password fields are use to authenticate
If no user credentials are provided, organization administrator credentials will be used
If no user credentials neither organization admin credentials are provided, credentials from pillar will be used
....
uid: user id to look for
password: password for the user
org_admin_user: organization admin username
org_admin_password: organization admin password
....
    return: The user information

=== user_list_assigned_system_groups
**(uid, org_admin_user=None, org_admin_password=None)**

Returns the system groups that a user can administer.
If no organization admin credentials are provided, credentials from pillar are used.

....
uid: user id to look for
org_admin_user: organization admin username
org_admin_password: organization admin password
....
    return: List of system groups that a user can administer

=== user_list_roles
**(uid, password=None, org_admin_user=None, org_admin_password=None)**

Get user roles.
If user password is provided name and password fields are use to authenticate
If no user credentials are provided, organization administrator credentials will be used
If no user credentials neither organization admin credentials are provided, credentials from pillar are used

....
uid: user id to look for
password: password for the user
org_admin_user: organization admin username
org_admin_password: organization admin password
....

    return: List of user roles assigned

=== user_list_users
**(org_admin_user=None, org_admin_password=None)**

Return all Uyuni users.
Uyuni XML-RPC listUsers return all users that are visible for the authenticated user.
This could be a sub-set of all existing users.

....
org_admin_user: organization admin username
org_admin_password: organization admin password
....

    return: List with all users visible to the authenticated user

=== user_remove_assigned_system_groups
**(uid, server_group_names, set_default=False, org_admin_user=None, org_admin_password=None)**

Remove system groups from a user's list of assigned system groups.
If no organization admin credentials are provided, credentials from pillar are used

....
uid: user id to look for
server_group_names: systems groups to remove from list of assigned system groups
set_default: Should system groups also be added to user's list of default system groups.
org_admin_user: organization admin username
org_admin_password: organization admin password
....
    return: boolean indication success in operation

=== user_remove_role
**(uid, role, org_admin_user=None, org_admin_password=None)**

Remove role from user.
If no organization admin credentials are provided, credentials from pillar are used

....
uid: user id to look for
role: role to be removed from the user
org_admin_user: organization admin username
org_admin_password: organization admin password
....

    return: boolean indication success in operation

=== user_set_details
**(uid, password, email, first_name=None, last_name=None, org_admin_user=None, org_admin_password=None)**

Update user details.
If no organization admin credentials are provided, credentials from pillar are used

....
uid: user id to look for
password: password for the user
email: user email address
first_name: user first name
last_name: user last name
org_admin_user: organization admin username
org_admin_password: organization admin password
....

    return: boolean indication success in operation
