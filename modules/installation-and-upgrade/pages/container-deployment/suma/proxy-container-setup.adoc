[[proxy-setup-containers]]
= {productname} {productnumber} Proxy Deployment

This quick start guide shows you how to prepare, configure and deploy a {productname} {productnumber} Proxy container on {micro} {microversion}.


== Hardware Requirements for the Proxy

This table shows the hardware requirements for deploying {productname} Proxy.

[cols="1,3,2", options="header"]
.Proxy Hardware Requirements
|===

| Hardware
| Details
| Recommendation

| CPU
| {x86_64}, {arm}
| Minimum 2 dedicated 64-bit CPU cores

| RAM
| Minimum
| 2 GB

|
| Recommended
| 8 GB

| Disk Space
| [path]``/`` (root directory)
| Minimum 40 GB

|
| [path]``/var/lib/containers/storage/volumes/srv-www``
| Minimum 100 GB, Storage requirements should be calculated for the number of ISO distribution images, containers, and bootstrap repositories you will use.

|
| [path]``/var/lib/containers/storage/volumes/var-cache`` (Squid)
| Minimum 100 GB

|===


.Supported operating system for the Proxy Container Host
[NOTE]
====
The supported operating system for the Proxy container host is {micro} {microversion}.
====



== {micro} {microversion} Installation

.Procedure: Download the Installation Media
. Locate the {micro} {microversion} installation media at https://www.suse.com/download/sle-micro/.
. You will need an account with {scc} and must be logged in to download the ISO.
. Download the following file: [filename]``SLE-Micro-5.5-DVD-x86_64-GM-Media1.iso`` 
. Prepare the installation media for use. For this guide a USB flash disk was used.
. For detailed documentation covering installation on bare metal or in a virtual machine, see link:https://documentation.suse.com/sle-micro/5.5/html/SLE-Micro-all/book-deployment-slemicro.html[{micro} {microversion} Deployment Guide].


.Procedure: {micro} {microversion} Installation 
. Use the arrow keys to select [systemitem]``Installation``.
. Adjust Keyboard and language. Click the [systemitem]``checkbox`` to accept the License Agreement.
. Click [systemitem]``Next`` to continue.
. Skip Registration.
. On the [systemitem]``NTP Configuration`` page click btn:[Next].
. On the [systemitem]``Authentication for the System`` page enter a password for the root user. Click btn:[Next].
. On the [systemitem]``Installation Settings`` page click btn:[Install].

This concludes installation of {micro} {microversion}.

Once the container host is prepared, the Proxy requires the following steps to complete configuration.



== Register the Proxy Host as a Minion with the Server

Before proceeding with configuration of the proxy you need to sync the correct channels, create a {salt} activation key and register the proxy host as a {salt} minion with {productname} {productnumber} Server.

[NOTE]
====
The container host for the {productname} Proxy must be registered as a salt minion to the {productname} Server.

For more information about registering a client to the {productname} Server, see xref:client-configuration:registration-overview.adoc[].
====

[IMPORTANT]
====
The following procedure assumes you have added your Organization Credentials to the menu:Admin[Setup Wizard -> Organization Credentials] page on the {productname} {productnumber} Server.
====

.Procedure: Prepare the Proxy and Required Channels
. Log in to the {productname} {webui}. 
. Select menu:Admin[Setup Wizard -> Products].
. Use the checkbox to select {micro} {microversion} then select the dropdown and check the Proxy Extension.
. Select the btn:[+ Add Products] button.
. Wait for the sync to complete.
. Select menu:Systems[Activation Keys] then click btn:[+ Create key].
. Create an activation key for the proxy host with {micro} {microversion} as the parent channel. This key should include all recommended channels and the proxy extension.
. Proceed to boostrapping the proxy host as a minion.

.Procedure: Bootstrap the Proxy Host
. Select menu:Systems[Bootstrapping].
. Fill in the fields for your Proxy host.
. Select the Activation key created in the previous step from the dropdown.
. Click btn:[+ Bootstrap].
. Wait for the Bootstrap process to complete successfully.
  Check the menu:Salt[] menu and confirm the {salt} minion key is listed and accepted.
. Reboot the Proxy host.
. Select the host from the menu:System[] list and trigger a second reboot after all events are finished to conclude the onboarding.

.Procedure: Update the Proxy Host
. Select the host from the menu:Systems[] list and apply all patches to update it.
. Reboot the Proxy host.

== Proxy Container Configuration and Deployment



[[proxy-setup-containers-generate-config]]
=== Create and generate the {productname} Proxy Configuration Files

The configuration archive of the {productname} Proxy is generated by the {productname} Server. Each additional Proxy requires its own configuration archive.
There are two paths for generating {productname} Proxy configuration archives: use the {webui} or the [literal]``spacecmd`` command.

The following tasks will be performed:

1. Generate {productname} a Proxy configuration archive file
2. Transfer the configuration archive to the container host from the Server and extract it
3. Start the Proxy with [literal]``mgrpxy``

[[proc-proxy-containers-setup-webui]]
.Procedure: Generating a Proxy Container Configuration using Web UI

. In the {webui}, navigate to menu:Systems[Proxy Configuration] and fill the required data:
. In the [guimenu]``Proxy FQDN`` field type fully qualified domain name for the proxy.
. In the [guimenu]``Parent FQDN`` field type fully qualified domain name for the {productname} Server or another {productname} Proxy.
. In the [guimenu]``Proxy SSH port`` field type SSH port on which SSH service is listening on {productname} Proxy. Recommended is to keep default 8022.
. In the [guimenu]``Max Squid cache size [MB]`` field type maximal allowed size for Squid cache. Typically this should be at most 60% of available storage for the containers.
. In the [guimenu]``SSL certificate`` selection list choose if new server certificate should be generated for {productname} Proxy or an existing one should be used.
You can consider generated certificates as {productname} builtin (self signed) certificates.
+
Depending on the choice then provide either path to signing CA certificate to generate a new certificate or path to an existing certificate and its key to be used as proxy certificate.
+
The CA certificates generated on the server are stored in the [path]``/root/ssl-build`` directory.
+
For more information about existing or custom certificates and the concept of corporate and intermediate certificates, see  xref:administration:ssl-certs-imported.adoc[].

. Click btn:[Generate] to register new proxy FQDN in {productname} Server and generate configuration archive with details for container host.
. After a few moments you are presented with file to download. Save this file locally.

image::suma_proxy_containerized_webui.png[scaledwidth=80%]


////
[[proc-proxy-containers-setup-spacecmd]]
.Procedure: Generating Of Container Services Configuration using spacecmd command

. In the console run following command:
+
----
spacecmd proxy_container_config_generate_cert -- <proxy_fqdn> <parent_fqdn> <squid_max_cache> <admin_email>
----

. Answer questions presented by script, namely {productname} credentials and CA password.
+
This will generate file `config.tar.gz` with configuration for the {productname} Proxy containers.
+
For more information about [literal]`spacecmd` container proxy generation, see xref:reference:spacecmd/proxy_container.adoc[].


If a [literal]``Proxy FQDN`` is used to generate {productname} Proxy container configuration that is not a registered minion, a new system entry will appear in system list.
This new entry will be shown under previously entered [literal]``Proxy FQDN`` value and will be of [literal]``Foreign`` system type.
////


[[proxy-setup-containers-transfer-config]]
== Transfer the Proxy Configuration

Both [command]``spacecmd`` command  and {webui} methods generate a configuration archive.
This archive needs to be made available on container host.


.Procedure: Copy the Proxy configuration generated with the spacecmd command
. Copy the files from the server container to the server host OS:
+
----
mgrctl cp server:/root/config.tar.gz .
----

. Next copy the files from the server host OS to the proxy host: 
+
----
scp config.tar.gz <proxy-FQDN>:/root
----

. Install the Proxy with:
+ 

----

mgrpxy install podman config.tar.gz
----

For installation instructions to use the archive to get the proxy containers, see xref:installation-and-upgrade:container-deployment/suma/proxy-deployment-suma.adoc[].






[[proxy-setup-containers-transfer-start]]
== Start {productname} Proxy containers

Container can now be started with the [literal]`mgrpxy` command:

[[proc-setup-containers-setup-start]]
.Procedure: Start {productname} Proxy containers

----
mgrpxy start uyuni-proxy-pod
----

Check if all containers started up as expected by calling

----
podman ps
----

Five {productname} Proxy containers should be present:

- proxy-salt-broker
- proxy-httpd
- proxy-tftpd
- proxy-squid
- proxy-ssh

And should be part of [literal]``proxy-pod`` container pod.


////
. List available extensions:
+
----
transactional-update --quiet register -list-extensions
----

. Add the Proxy extension:
----
transactional-update register -p SUSE-Manager-Proxy/5.0/x86_64 -r ADDITIONAL REGCODE
----
////