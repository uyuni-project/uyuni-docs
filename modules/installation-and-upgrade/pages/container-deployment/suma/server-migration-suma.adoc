= Migrating the {productname} Server to a Containerized Environment
ifeval::[{uyuni-content} == true]
:noindex:
endif::[]

// We need to figure out which SUMA versions prior to the container release can or should be migrated. Something like any version prior to yyyy.mm and later than.

To migrate a {productname} {productnumber} Server to a container, a new machine is required.


[IMPORTANT]
====
An in-place migration from {productname} 4.3 to 5.0 will remain unsupported because of the change of the underlying operating system from {sles} 15 SP4 to {micro} {microversion}.

The traditional contact protocol is no longer supported in {productname} 5.0 and later.
Before migrating from {productname} 4.3 to {productnumber}, any existing traditional clients including the traditional proxies must be migrated to {salt}.

For more information about migrating traditional {productname} 4.3 clients to {salt} clients, see https://documentation.suse.com/suma/4.3/en/suse-manager/client-configuration/contact-methods-migrate-traditional.html.
====


The original server is referred to as the **source server,** while the newly set-up machine is designated as the **destination server.**


[IMPORTANT]
====
Self trusted GPG keys are not migrated.
GPG keys that are trusted in the RPM database only are not migrated.
Thus synchronizing channels with [command]``spacewalk-repo-sync`` can fail.

The administrator must migrate these keys manually from the 4.3 installation **after migration**:

1. Copy the keys from the source server to the container host of the destination server.
2. Add the keys to the container with [command]``mgradm gpg add ...``.
====



[IMPORTANT]
====
Trusted SSL CA certificates that were installed as part of an RPM and store on {productname} 4.3 in the [path]``/usr/share/pki/trust/anchors/`` directory will not be migrated.
Because {suse} does not install RPM packages in the container, the administrator must migrate these certificate files manually from the 4.3 installation **after migration**:

1. Copy the file from the 4.3 server to the new server.
   For example, as [path]``/local/ca.file``.

2. Copy the file into the container with:
+

----
mgradm cp /local/ca.file server:/etc/pki/trust/anchors/
----
====

The migration procedure currently does not include any hostname renaming functionality.
The fully qualified domain name (FQDN) of the new {productnumber} server will remain identical to the one of the old 4.3 server.
Therefore, after the migration, it will be necessary to manually adjust the DNS records and IP to point to the new server.


== Initial Preparation on the Old 4.3 Server

.Procedure: Initial preparation on the 4.3 server
. Stop the {productname} services:
+

----
spacewalk-service stop
----

. Stop the PostgreSQL service:
+

----
systemctl stop postgresql
----


== Prepare the SSH Connection

.Procedure: Preparing the SSH connection
. The SSH configuration and agent should be ready on the new {productnumber} server for a passwordless connection to the 4.3 server.
+

[NOTE]
====
To establish a passwordless connection, the migration script relies on an SSH agent running on the {productnumber} server.
If the agent is not active yet, initiate it by running [command]``eval $(ssh-agent)``.
Then, add the SSH key to the running agent with [command]``ssh-add /path/to/the/private/key``.
You will be prompted to enter the password for the private key during this process.
====

. The migration script only uses the 4.3 server's FQDN in the SSH command.

. This means that every other configuration required to connect, needs to be defined in the [path]``~/.ssh/config`` file.


== Perform the Migration

[IMPORTANT]
====
When planning your migration from {productname} 4.3 to {productname} 5.0, ensure that your target instance meets or exceeds the specifications of your current setup.
This includes, but is not limited to, [literal]``Memory (RAM)``, [literal]``CPU Cores``, [literal]``Storage``, [literal]``Network Bandwidth``, etc.
====

.Procedure: Performing the Migration
. This step is optional.
However, if custom persistent storage is required for your infrastructure, use the [command]``mgr-storage-server`` tool.
** For more information, see [command]``mgr-storage-server --help``.
This tool simplifies creating the container storage and database volumes.

** Use the command in the following manner:
+

----
mgr-storage-server <storage-disk-device> [<database-disk-device>]
----
+
For example:
+
----
mgr-storage-server /dev/nvme1n1 /dev/nvme2n1
----
+
[NOTE]
====
This command will create the persistent storage volumes at [path]``/var/lib/containers/storage/volumes``.

For more information, see xref:installation-and-upgrade:container-management/persistent-container-volumes.adoc[].
====
. Execute the following command to install a new {productname} server, replacing **<oldserver.fqdn>** with the appropriate FQDN of the 4.3 server:
+

----
mgradm migrate podman <oldserver.fqdn>
----

[IMPORTANT]
====

After successfully running the [command]``mgradm migrate`` command, the {salt} setup on all clients will still point to the old 4.3 server.
To redirect them to the {productnumber} server, it is required to rename the new server at the infrastructure level (DHCP and DNS) to use the same Fully Qualified Domain Name and IP address as 4.3 server.

====

// uncomment when kubernetes support is added
//----
//mgradm migrate kubernetes <source.fqdn>
//----
