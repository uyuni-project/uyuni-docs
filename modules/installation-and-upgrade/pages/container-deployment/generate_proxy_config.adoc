// Add section on how to generated the proxy configuration files

[[proxy-setup-containers-generate-config]]
== Generate the Proxy Configuration

The configuration archive of the {productname} Proxy is generated by the {productname} Server.
Each additional Proxy requires its own configuration archive.

[NOTE]
====
2 GB represents the default proxy squid cache size. This will need to be adjusted for your environment.
====

[IMPORTANT]
====
For Podman deployment, the container host for the {productname} Proxy must be registered as a client to the {productname} Server prior to generating this proxy configuration.
====

If a proxy FQDN is used to generate a proxy container configuration that is not a registered client (as in the Kubernetes use case), a new system entry will appear in system list. 
This new entry will be shown under previously entered Proxy FQDN value and will be of [literal]``Foreign`` system type.

=== Generate the Proxy Configuration with {webui}

[[proc-proxy-containers-setup-webui]]
.Procedure: Generating a Proxy Container Configuration using {webui}

. In the {webui}, navigate to menu:Systems[Proxy Configuration] and fill the required data:
. In the [guimenu]``Proxy FQDN`` field type fully qualified domain name for the proxy.
. In the [guimenu]``Parent FQDN`` field type fully qualified domain name for the {productname} Server or another {productname} Proxy.
. In the [guimenu]``Proxy SSH port`` field type SSH port on which SSH service is listening on {productname} Proxy. Recommended is to keep default 8022.
. In the [guimenu]``Max Squid cache size [MB]`` field type maximal allowed size for Squid cache.
  Recommended is to use at most 60% of available storage for the containers.
+

[NOTE]
====
2 GB represents the default proxy squid cache size.
This will need to be adjusted for your environment.
====

. In the [guimenu]``SSL certificate`` selection list choose if new server certificate should be generated for {productname} Proxy or an existing one should be used.
You can consider generated certificates as {productname} builtin (self signed) certificates.
+
Depending on the choice then provide either path to signing CA certificate to generate a new certificate or path to an existing certificate and its key to be used as proxy certificate.
+
The CA certificates generated by the server are stored in the [path]``/var/lib/containers/storage/volumes/root/_data/ssl-build`` directory.
+
For more information about existing or custom certificates and the concept of corporate and intermediate certificates, see  xref:administration:ssl-certs-imported.adoc[].

. Click btn:[Generate] to register a new proxy FQDN in the {productname} Server and generate a configuration archive ([filename]``config.tar.gz``) containing details for the container host.
. After a few moments you are presented with file to download.
  Save this file locally.

image::suma_proxy_containerized_webui.png[scaledwidth=80%]


=== Generate the Proxy Configuration with spacecmd and Self-Signed Certificate

.Procedure: Generating Proxy Configuration with spacecmd and Self-Signed Certificate
You can generate a Proxy configuration using spacecmd.

. SSH into your container host.

. Execute the following command replacing the Server and Proxy FQDN:
+
----
mgrctl exec -ti 'spacecmd proxy_container_config_generate_cert -- dev-pxy.example.com dev-srv.example.com 2048 email@example.com' -o /tmp/config.tar.gz
----

. Copy the generated configuration from the server container:
+
----
mgrctl cp server:/tmp/config.tar.gz .
----


=== Generate the Proxy Configuration with spacecmd and Custom Certificate

You can generate a Proxy configuration using spacecmd for a custom certificates rather than the default self-signed certificates.

.Procedure: Generating Proxy Configuration with spacecmd and Custom Certificate
. SSH into your Server container host.
. Execute the following command replacing the Server and Proxy FQDN:
+

----
for f in ca.crt proxy.crt proxy.key; do
  mgrctl cp $f server:/tmp/$f
done
mgrctl exec -ti 'spacecmd proxy_container_config -- -p 8022 pxy.example.com srv.example.com 2048 email@example.com /tmp/ca.crt /tmp/proxy.crt /tmp/proxy.key -o /tmp/config.tar.gz'
----

. Copy the generated configuration from the server container:
+

----
mgrctl cp server:/tmp/config.tar.gz .
----

